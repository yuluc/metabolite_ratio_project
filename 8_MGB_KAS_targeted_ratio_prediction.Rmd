---
title: "targeted metabolitess ratio associated with asthma phenotypes in PEGASUS"
subtitle: "asthma, lung function, IgE, and OCS use (exacerbation)"
author: "Yulu Chen"
date: "08/28/2023"
output: 
  html_document: 
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: false
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
##### 1. Setup #####
## Packages

pkg <- c("tidyverse", "data.table", "here", "survival", "gtools", "tableone", "DT", "sjPlot", 
         "sjmisc", "grid", "gridExtra", "ggpubr", "table1", "xlsx",
         "ggvenn", "readxl", "pheatmap","ggrepel", "Hmisc", "glmnet", "mltools", 
         "cluster", "factoextra", "dendextend", "WGCNA", "survminer", "pROC", "caret", "randomForest",
         "e1071")
for (p in pkg) {
        if (require(p, character.only = T)) {
                print(paste0(p, " loaded successfully"))
        } else {
                install.packages(p)
                require(p, character.only = T)
                print(paste0(p, " downloaded and loaded successfully"))
        }
}

## Paths
dat_dir <- "data/"
fig_dir <- "figures/12/5/"
res_dir <- "results/12/5/"

## Hard-coded numbers

missing_thld <- 0.30
alpha_thld <- 0.05
z_95 <- qnorm(p = 0.975)

## Functions

save_pheatmap_png <- function(x, filename, width = 16, height = 16, units = "in", res = 300) {
        png(filename, width = width, height = height, units = units, res = res)
        grid::grid.newpage()
        grid::grid.draw(x$gtable)
        dev.off()
}

pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- as.data.frame(summary(aov(y ~ g))[[1]])[1,5]
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}
```

# 1. Load data
## 1.1 all platform data
```{r}

load(here(dat_dir, "all_platforms_data_updated_Yulu_12192021.RData"), verbose = T)

targeted_list <- c(sph_mets_info[, feat_id], 
                   microb_mets_info[, feat_id],
                   str_mets_info[, feat_id])

targeted_list_analysis <- c(sph_mets_info[pct_na_met <= 0.30, feat_id], 
                            microb_mets_info[pct_na_met <= 0.30, feat_id],
                            str_mets_info[pct_na_met <= 0.30, feat_id])

targeted_sph_list <- sph_mets_info[pct_na_met <= 0.30, feat_id]
targeted_microb_list <- microb_mets_info[pct_na_met <= 0.30, feat_id]
targeted_str_list <- str_mets_info[pct_na_met <= 0.30, feat_id]

## phenotypes from RPDR (from Qingwen)
pheno_rpdr <- fread("/Users/yuluchen/Dropbox (Partners HealthCare)/Personal/PEGASUS/SNF_targeted_panels/data/PEGASUS_pheno.csv")

pheno_rpdr$`FEV1_FVC_most_recent` <- (pheno_rpdr$FEV1_most_recent)/(pheno_rpdr$FVC_most_recent)

pheno_rpdr$`FEV1_FVC_median_6M` <- (pheno_rpdr$FEV1_median_6M)/(pheno_rpdr$FVC_median_6M)

pheno_rpdr$`FEV1_FVC_median_12M` <- (pheno_rpdr$FEV1_median_12M)/(pheno_rpdr$FVC_median_12M)

pheno_rpdr$`FEV1_FVC_median_24M` <- (pheno_rpdr$FEV1_median_24M)/(pheno_rpdr$FVC_median_24M)


# ICS and OCS after sample collection
med_after_df <- fread("/Users/yuluchen/Dropbox (Partners HealthCare)/Personal/PEGASUS/RPDR_data_extracted/results/med_corticosteroids_after_sample_collection_summary.csv")
colnames(med_after_df)[2:19] <-paste(colnames(med_after_df)[2:19], "after",sep="_")
med_after_df <- med_after_df[,-20]

ics_after_df <- fread("/Users/yuluchen/Dropbox (Partners HealthCare)/Personal/PEGASUS/RPDR_data_extracted/results/med_first_ics_after_sample_collection.csv")
ics_after_df <- ics_after_df[,c("EMPI", "Medication_Date", "Collect_Date", "ics", "cs_timegap_d", "cs_timegap_y")]
colnames(ics_after_df)[2:6] <-paste(colnames(ics_after_df)[2:6], "ics_after",sep="_")


ocs_after_df <- fread("/Users/yuluchen/Dropbox (Partners HealthCare)/Personal/PEGASUS/RPDR_data_extracted/results/med_first_ocs_after_sample_collection.csv")
ocs_after_df <- ocs_after_df[,c("EMPI", "Medication_Date", "Collect_Date", "ocs", "cs_timegap_d", "cs_timegap_y")]
colnames(ocs_after_df)[2:6] <-paste(colnames(ocs_after_df)[2:6], "ocs_after",sep="_")

```


## 1.2 targeted data
because we need to calculate the ratio, we cannot use standarized data, we will used raw data

### 1.2.1 sphingolipid

unit: nM
```{r}
sph_dat <- read_xlsx("~/Dropbox (Partners HealthCare)/PEGASUS/sphingolipids_targeted/data/2020-02-12_PEGASuS_SLs.xlsx", sheet = "Samples", skip = 2) %>% as.data.table()
setnames(sph_dat, gsub(" ", "_", colnames(sph_dat)))
setnames(sph_dat, "3_KS", "X3_KS")

which(colnames(sph_dat) == "Comments_sample") # 17
which(colnames(sph_dat) == "SubjectID") # 6
sph_dat <- sph_dat[,-c(1:5,7:17)]
colnames(sph_dat)[1] <- "Biobank_Subject_ID"

sph_mets_info$`SUPER PATHWAY` <- "Sphingolipid Metabolism"
sph_mets_info[, `SUB PATHWAY` := case_when(grepl("^HexCer|LacCer", feat_id) ~ "Hex/LacCeramide", 
                                    grepl("^SM", feat_id) ~ "Sphingomyelin", 
                                    grepl("^Sph|Sphd|S1P", feat_id) ~ "Sphingosine/S1P", 
                                    grepl("^Cer1P", feat_id) ~ "Ceramide-1-phosphate", 
                                    grepl("^Cer[1-2][0-9]", feat_id) ~ "Ceramide", 
                                    grepl("^DhCer", feat_id) ~ "Dihydroceramide", 
                                    grepl("^Spa|Spa1P", feat_id) ~ "Sphinganine/Spa1P", 
                                    feat_id == "Glucosph" ~ "Hexosylsphingosine", 
                                    feat_id == "X3_KS" ~ "X3_Ketosphinganine")]
```

### 1.2.2 microbial metabolite

unit: ug/ml
```{r}
link_id <- fread("~/Dropbox (Partners HealthCare)/PEGASUS/precion_targeted/data/list_of_BIOBANK_samples.csv")
setnames(link_id, "SUBJ_ALIASID", "Biobank_Subject_ID")
# link_id[, .N, Biobank_Subject_ID][N == 2] 
# Remvoe duplicated records for this subject
link_id <- link_id[!duplicated(Biobank_Subject_ID), ]

microb_mets <- read_xlsx("~/Dropbox (Partners HealthCare)/PEGASUS/precion_targeted/data/PR003-21_AsthmaCohort1125_MicrobiomePanel_CDT_Test.xlsx") %>% as.data.table()
setnames(microb_mets, gsub("[ ()/]", "_", colnames(microb_mets)))
microb_mets[, feat_id := str_c("X", seq(1, .N), "_microb")]
setcolorder(microb_mets, "feat_id")
microb_mets_cols <- microb_mets_info$feat_id
microb_mets_cols <- microb_mets_cols[!microb_mets_cols %in% "trypkynu_ratio_microb"]

subj_cols <- colnames(microb_mets)[-c(2:which(colnames(microb_mets) == "ALOQ__ug_mL_"))]
microb_mets_dat <- microb_mets[, ..subj_cols] %>% as.data.frame() 
rownames(microb_mets_dat) <- microb_mets_dat$feat_id
microb_mets_dat$feat_id <- NULL
microb_mets_dat <- t(microb_mets_dat) %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()
setnames(microb_mets_dat, "rowname", "S_SAMPLEID")

microb_mets_dat[, (microb_mets_cols) := lapply(.SD, as.character), .SDcols = microb_mets_cols]
suppressWarnings(microb_mets_dat[, (microb_mets_cols) := lapply(.SD, as.numeric), .SDcols = microb_mets_cols])
microb_mets_dat <- merge(microb_mets_dat, link_id[, .(Biobank_Subject_ID, S_SAMPLEID)], by = "S_SAMPLEID")

microb_mets_dat %>% setcolorder(., "Biobank_Subject_ID")
microb_mets_dat <- microb_mets_dat[,-2]

```

### 1.2.3 steroid

unit: ng/ml
```{r}
# link id
link_id <- read_xlsx("~/Dropbox (Partners HealthCare)/PEGASUS/steroid_targeted/data/BIOBANK_Serum_manifest.xlsx", sheet = 1) %>% as.data.table()
link_id <- link_id[,c(3,5)]
colnames(link_id) <- c("sampleID_biobank", "Biobank_Subject_ID")
link_id$Biobank_Subject_ID <- as.integer(as.character(link_id$Biobank_Subject_ID))

steroid_df <- read_xlsx("~/Dropbox (Partners HealthCare)/PEGASUS/steroid_targeted/data/PR005-21_AsthmaCohort1125_Steroids_CDT_062821.xlsx", sheet = 1) %>% as.data.table()

# add a feat id and feature
steroid_df[, ':=' (feature = str_c("S", seq(1, .N)),
                   feat_id = str_c("S", seq(1, .N), "_steroid"))]

# transpose the steroid data
steroid_dat <- steroid_df[, c(11:1135)]
steroid_dat <- as.data.frame(t(steroid_dat))
colnames(steroid_dat) <- steroid_df$feat_id

# change NQ to be NA
steroid_dat[steroid_dat == "NQ"] <- NA

#
steroid_dat[] <- lapply(steroid_dat, function(x) as.numeric(as.character(x)))
steroid_dat <- as.data.frame(cbind(rownames(steroid_dat), steroid_dat))
colnames(steroid_dat)[1] <- "sampleID_biobank"
steroid_dat <- as.data.table(steroid_dat)
steroid_dat <- merge(link_id, steroid_dat, by = "sampleID_biobank", all.x = T)

steroid_dat <- steroid_dat[,-1]

## subject 10009114 has duplicated steroid measure so I remove this subjects
steroid_dat <- steroid_dat[!(Biobank_Subject_ID == 10009114),]

```

# 2. Create targeted ratio
## 2.1 targeted sph/targeted microb
```{r}
df <- merge(sph_dat, microb_mets_dat, by = "Biobank_Subject_ID", all = T) %>% as.data.frame()
rownames(df) <- df$Biobank_Subject_ID
df <- df[,-1]

sph_list <- colnames(sph_dat)[-1]
microb_list <- colnames(microb_mets_dat)[-1]

df_ratios <- df

for (i in 1:length(sph_list)) {
  for (j in 1:length(microb_list)) {
    sph <- sph_list[i]
    microb <- microb_list[j]
    eval(parse(text = str_c("df_ratios$", sph, ".", microb ," <- df_ratios$", sph, "/", "df_ratios$", microb)))
  }
}

df_ratios <- df_ratios[,-which(colnames(df_ratios) %in% colnames(df))]
ncol(df_ratios)

df_sph_microb_ratio <- df_ratios
df_sph_microb_ratio$Biobank_Subject_ID <- rownames(df_sph_microb_ratio)
df_sph_microb_ratio %>% setcolorder(., "Biobank_Subject_ID")
df_sph_microb_ratio <- as.data.table(df_sph_microb_ratio)
df_sph_microb_ratio_log <- df_sph_microb_ratio
df_sph_microb_ratio_log[,c(2:5461)] <- log2(df_sph_microb_ratio_log[,c(2:5461)])

df_sph_microb_ratio_log <- df_sph_microb_ratio_log %>% mutate_if(is.numeric, ~ replace(., !is.finite(.), NA))

# missing
mets_missing_sph_microb <- df_sph_microb_ratio_log[, lapply(.SD, function(x) mean(is.na(x))), .SDcols = colnames(df_sph_microb_ratio_log)[2:ncol(df_sph_microb_ratio_log)]] %>% 
        t() %>% as.data.frame() %>% rownames_to_column()
setnames(mets_missing_sph_microb, c("feat_id", "pct_na_met"))
summary(mets_missing_sph_microb$pct_na_met)
ggplot(mets_missing_sph_microb) + 
        geom_histogram(aes(pct_na_met), bins = 50) + 
        labs(title = "targeted sph/targeted microb ratio missingness")


ggplot(df_sph_microb_ratio, aes(x=Cer24_0d16_1.X41_microb)) + geom_histogram(color="darkblue", fill="lightblue")
ggplot(df_sph_microb_ratio_log, aes(x=Cer24_0d16_1.X41_microb)) + geom_histogram(color="darkblue", fill="lightblue")

```

## 2.2 targeted sph/targeted str
```{r}
df <- merge(sph_dat, steroid_dat, by = "Biobank_Subject_ID", all = T) %>% as.data.frame()
rownames(df) <- df$Biobank_Subject_ID
df <- df[,-1]

steroid_list <- colnames(steroid_dat)[-1]

df_ratios <- df

for (i in 1:length(sph_list)) {
  for (j in 1:length(steroid_list)) {
    sph <- sph_list[i]
    steroid <- steroid_list[j]
    eval(parse(text = str_c("df_ratios$", sph, ".", steroid ," <- df_ratios$", sph, "/", "df_ratios$", steroid)))
  }
}

df_ratios <- df_ratios[,-which(colnames(df_ratios) %in% colnames(df))]
ncol(df_ratios)

df_sph_steroid_ratio <- df_ratios
df_sph_steroid_ratio$Biobank_Subject_ID <- rownames(df_sph_steroid_ratio)
df_sph_steroid_ratio %>% setcolorder(., "Biobank_Subject_ID")
df_sph_steroid_ratio <- as.data.table(df_sph_steroid_ratio)
df_sph_steroid_ratio_log <- df_sph_steroid_ratio
df_sph_steroid_ratio_log[,c(2:1404)] <- log2(df_sph_steroid_ratio_log[,c(2:1404)])

df_sph_steroid_ratio_log <- df_sph_steroid_ratio_log %>% mutate_if(is.numeric, ~ replace(., !is.finite(.), NA))

# missing
mets_missing_sph_str <- df_sph_steroid_ratio_log[, lapply(.SD, function(x) mean(is.na(x))), .SDcols = colnames(df_sph_steroid_ratio_log)[2:ncol(df_sph_steroid_ratio_log)]] %>% 
        t() %>% as.data.frame() %>% rownames_to_column()
setnames(mets_missing_sph_str, c("feat_id", "pct_na_met"))
summary(mets_missing_sph_str$pct_na_met)
ggplot(mets_missing_sph_str) + 
        geom_histogram(aes(pct_na_met), bins = 50) + 
        labs(title = "targeted sph/targeted str ratio missingness")

ggplot(df_sph_steroid_ratio, aes(x=LacCer14_0.S10_steroid	)) + geom_histogram(color="darkblue", fill="lightblue")
ggplot(df_sph_steroid_ratio_log, aes(x=LacCer14_0.S10_steroid	)) + geom_histogram(color="darkblue", fill="lightblue")

```

## 2.3 targeted microb/targeted str
```{r}
df <- merge(microb_mets_dat, steroid_dat, by = "Biobank_Subject_ID", all = T) %>% as.data.frame()
rownames(df) <- df$Biobank_Subject_ID
df <- df[,-1]

df_ratios <- df

for (i in 1:length(microb_list)) {
  for (j in 1:length(steroid_list)) {
    microb <- microb_list[i]
    steroid <- steroid_list[j]
    eval(parse(text = str_c("df_ratios$", microb, ".", steroid ," <- df_ratios$", microb, "/", "df_ratios$", steroid)))
  }
}

df_ratios <- df_ratios[,-which(colnames(df_ratios) %in% colnames(df))]
ncol(df_ratios)

df_microb_steroid_ratio <- df_ratios
df_microb_steroid_ratio$Biobank_Subject_ID <- rownames(df_microb_steroid_ratio)
df_microb_steroid_ratio %>% setcolorder(., "Biobank_Subject_ID")
df_microb_steroid_ratio <- as.data.table(df_microb_steroid_ratio)
df_microb_steroid_ratio_log <- df_microb_steroid_ratio
df_microb_steroid_ratio_log[,c(2:1261)] <- log2(df_microb_steroid_ratio_log[,c(2:1261)])

df_microb_steroid_ratio_log <- df_microb_steroid_ratio_log %>% mutate_if(is.numeric, ~ replace(., !is.finite(.), NA))

# missing
mets_missing_microb_str <- df_microb_steroid_ratio_log[, lapply(.SD, function(x) mean(is.na(x))), .SDcols = colnames(df_microb_steroid_ratio_log)[2:ncol(df_microb_steroid_ratio_log)]] %>% 
        t() %>% as.data.frame() %>% rownames_to_column()
setnames(mets_missing_microb_str, c("feat_id", "pct_na_met"))
summary(mets_missing_microb_str$pct_na_met)
ggplot(mets_missing_microb_str) + 
        geom_histogram(aes(pct_na_met), bins = 50) + 
        labs(title = "targeted microb/targeted str ratio missingness")
```


# 3. Regression model function
## 3.1 logistic regression
```{r}
## test
# fit <- glm(Asthma_Status ~ F100_hilic_pos + bmi, data = pheno_mets, family = 'binomial')
# summary(fit)
# fit <- glm(asthma_num ~ F100_hilic_pos + bmi, data = pheno_mets, family = 'binomial')
# summary(fit)
# 
# coef <- summary(fit)$coefficients %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()
# coef <- coef[rowname  == "F100_hilic_pos", ]
# 
# output <- cbind("Asthma_Status", coef)
# colnames(output) <- c("outc", "feat_id", "beta", "zval", "pval")
# output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]

logi_res_fnc <- function(outc, mets_list, dat, add_covar = "",
                         first_cols = c("feat_id", 
                                        "outc", "beta", "pval", "fdr", "or", "lower95", "upper95")) {
        
        logi_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("glm(", outc, " ~ ", met, add_covar, ", data = ", dat, ", family = 'binomial')")))
                
                coef <- summary(fit)$coefficients %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()
                coef <- coef[rowname == met, ]

                output <- cbind(outc, coef)
                colnames(output) <- c("outc", "feat_id", "beta", "se", "zval", "pval")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {logi_mdl_tmp(met = x)}) %>% rbindlist()
        
        # eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        # res <- merge(res, mets_info, by = "feat_id", all.x = T)
        res[, ':='(neg_log10_pval = -log10(pval), 
                   fdr = p.adjust(pval, method = "fdr"), 
                   or = exp(beta), 
                   lower95 = exp(beta-z_95*se), 
                   upper95 = exp(beta+z_95*se))]
        res[, totaln := eval(parse(text = str_c(dat, "[!is.na(", outc, "), .N]")))]
        
        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}

```

## 3.2 conditional logistic regression
```{r}
clogi_res_fnc <- function(outc, mets_list, dat, mets_info, add_covar = "", 
                          first_cols = c("feat_id", 
                                         "beta", "pval", "or", "fdr", "lower95", "upper95")) {
        
        clogi_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("clogit(", outc, " ~ ", met, " + strata(Stratum)", 
                                               add_covar, ", data = ", dat, ", iter.max=50)")))
                
                coef <- summary(fit)$coefficients
                coef <- coef[rownames(coef) == met, ]

                totaln <- summary(fit)$n
                casen <- summary(fit)$nevent
                
                output <- t(c(outc, met, coef, totaln, casen)) %>% as.data.table()
                colnames(output) <- c("outc", "feat_id", "beta", "or", "se", "zval", "pval", 
                                      "totaln", "casen")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {clogi_mdl_tmp(met = x)}) %>% rbindlist()
        
        eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        # res <- merge(res, mets_info, by = "feat_id")
        res[, fdr := p.adjust(pval, method = "fdr")]
        res[, ':='(lower95 = exp(beta - z_95 * se), 
                   upper95 = exp(beta + z_95 * se))] 
        
        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}
```


## 3.3 linear regression
```{r}
# test
# fit <- lm(ocs_trim_totnum_5y ~ Cer20_1d18_1.S10_steroid +Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
# summary(fit)
# coef <- summary(fit)$coefficients %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()

linreg_res_fnc <- function(outc, mets_list, dat, add_covar = "", 
                           first_cols = c("feat_id", "outc", "beta", "pval", "fdr", "fdr_bh"), 
                           na_thld = missing_thld) {
        
        linear_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("lm(", outc, " ~ ", met, 
                                               add_covar, ", data = ", dat, ")")))
                
                coef <- summary(fit)$coefficients %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()
                coef <- coef[rowname == met, ]

                output <- cbind(outc, coef)
                colnames(output) <- c("outc", "feat_id", "beta", "se", "tval", "pval")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {linear_mdl_tmp(met = x)}) %>% rbindlist()
        
        # eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        # res <- merge(res, mets_info, by = "feat_id")
        res[, ':='(fdr = p.adjust(pval, method = "fdr"), 
                   fdr_bh = p.adjust(pval, method = "BH"))]
        res[, totaln := eval(parse(text = str_c(dat, "[!is.na(", outc, "), .N]")))]

        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}

```

## 3.4 Poisson regression
```{r}
# test
# fit <- glm(ocs_trim_totnum_5y ~ Cer20_1d18_1 + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, family="quasipoisson", data = pheno_tmp)
# summary(fit)
# coef <- summary(fit)$coefficients %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()

poiss_res_fnc <- function(outc, mets_list, dat, add_covar = "",
                         first_cols = c("feat_id", 
                                        "outc", "beta", "pval", "fdr")) {
        
        logi_mdl_tmp <- function(met) {
                
                fit <- eval(parse(text = str_c("glm(", outc, " ~ ", met, add_covar, ", data = ", dat, ", family = 'quasipoisson')")))
                
                coef <- summary(fit)$coefficients %>% as.data.frame() %>% rownames_to_column() %>% as.data.table()
                coef <- coef[rowname == met, ]

                output <- cbind(outc, coef)
                colnames(output) <- c("outc", "feat_id", "beta", "se", "zval", "pval")
                output[, (colnames(output)[-c(1:2)]) := lapply(.SD, as.numeric), .SDcols = colnames(output)[-c(1:2)]]
                
                return(output)
        }
        
        res <- lapply(mets_list, function(x) {logi_mdl_tmp(met = x)}) %>% rbindlist()
        
        # eval(parse(text = str_c("mets_info <- copy(", mets_info, ")")))
        # res <- merge(res, mets_info, by = "feat_id", all.x = T)
        res[, ':='(neg_log10_pval = -log10(pval), 
                   fdr = p.adjust(pval, method = "fdr"))]
        res[, totaln := eval(parse(text = str_c(dat, "[!is.na(", outc, "), .N]")))]
        
        setcolorder(res, first_cols)
        res <- res[order(pval)]
        return(res)
}

```

# 4. Make the ics category variables in asthma group
## 4.1 Make the pheno data
```{r}
# keep standardized targeted met data
mets_info_global <- mets_info_all[platform %in% c("HILIC-pos", "Lipid-neg", "Lipid-pos"),]
pheno_df <- pheno_mets_trim[,c(mets_info_global$feat_id) := NULL]
pheno_df$Biobank_Subject_ID <- as.character(pheno_df$Biobank_Subject_ID)

which(colnames(pheno_rpdr) == "Subject_ID")
colnames(pheno_rpdr)[10] <- "Biobank_Subject_ID"

# Add Qingwen's RPDR data
col.name_1 <- colnames(pheno_df)
col.name_2 <- colnames(pheno_rpdr)
col.name_3 <- col.name_2[!(col.name_2 %in% col.name_1)]
col.name_3 <- append("Biobank_Subject_ID", col.name_3)

pheno_df$Biobank_Subject_ID <- as.integer(pheno_df$Biobank_Subject_ID)

pheno_df_new <- merge(pheno_df, pheno_rpdr[,..col.name_3], by = "Biobank_Subject_ID", all.x = T)


# Add ICS and OCS data after collection date
pheno_df_new <- merge(pheno_df_new, med_after_df, by = "EMPI", all.x = T)
pheno_df_new <- merge(pheno_df_new, ics_after_df, by = "EMPI", all.x = T)
pheno_df_new <- merge(pheno_df_new, ocs_after_df, by = "EMPI", all.x = T)

```


## 4.2 Make the ics category variables in asthma group
### 4.2.1 Definine ICS use as 2 categories: ics and no ics
```{r}
# within 1y
pheno_df_new$ics_y_n_1y <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_1y >= 4, "ics", "noics")))
pheno_df_new[, .N, .(ics_y_n_1y)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 2y
pheno_df_new$ics_y_n_2y <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_2y >= 8, "ics", "noics")))
pheno_df_new[, .N, .(ics_y_n_2y)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 3y
pheno_df_new$ics_y_n_3y <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_3y >= 12, "ics", "noics")))
pheno_df_new[, .N, .(ics_y_n_3y)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 5y
pheno_df_new$ics_y_n_5y <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_5y >= 20, "ics", "noics")))
pheno_df_new[, .N, .(ics_y_n_5y)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 10y
pheno_df_new$ics_y_n_10y <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                     ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_10y >= 40, "ics", "noics")))
pheno_df_new[, .N, .(ics_y_n_10y)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

```


### 4.2.2 Definine ICS use as 3 categories: noics, maybe, ics

Key: No ics= ics_totnum of 0  

     Maybe > 0 but <= mean
     
     Yes ics => mean
     
```{r}
# within 1y
pheno_df_new$ics_1y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_1y == 0, "noics", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_1y > 0 & pheno_df_new$ics_trim_totnum_1y <= 2.632, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_1y > 2.632, "ics", "<NA>")))))
pheno_df_new[, .N, .(ics_1y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 2y
pheno_df_new$ics_2y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_2y == 0, "noics", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_2y > 0 & pheno_df_new$ics_trim_totnum_2y <= 5.173, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_2y > 5.173, "ics", "<NA>")))))
pheno_df_new[, .N, .(ics_2y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 3y
pheno_df_new$ics_3y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_3y == 0, "noics", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_3y > 0 & pheno_df_new$ics_trim_totnum_3y <= 7.498, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_3y > 7.498, "ics", "<NA>")))))
pheno_df_new[, .N, .(ics_3y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 5y
pheno_df_new$ics_5y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_5y == 0, "noics", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_5y > 0 & pheno_df_new$ics_trim_totnum_5y <= 10.88, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_5y > 10.88, "ics", "<NA>")))))
pheno_df_new[, .N, .(ics_5y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 10y
pheno_df_new$ics_10y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_10y == 0, "noics", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_10y > 0 & pheno_df_new$ics_trim_totnum_10y <= 14.7, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ics_trim_totnum_10y > 14.7, "ics", "<NA>")))))
pheno_df_new[, .N, .(ics_10y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

```


### 4.2.3 Definine OCS use as 3 categories: noics, maybe, ics

Key: No ocs= ocs_totnum of 0  

     Maybe > 0 but <= mean
     
     Yes ocs => mean
     
```{r}
# within 1y
mean(pheno_df_new$ocs_trim_totnum_1y, na.rm = T)
pheno_df_new$ocs_1y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_1y == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_1y > 0 & pheno_df_new$ocs_trim_totnum_1y <= 2.037037, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_1y > 2.037037, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_1y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 2y
mean(pheno_df_new$ocs_trim_totnum_2y, na.rm = T)
pheno_df_new$ocs_2y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_2y == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_2y > 0 & pheno_df_new$ocs_trim_totnum_2y <= 3.524074, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_2y > 3.524074, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_2y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 3y
mean(pheno_df_new$ocs_trim_totnum_3y, na.rm = T)
pheno_df_new$ocs_3y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_3y == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_3y > 0 & pheno_df_new$ocs_trim_totnum_3y <= 4.642593, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_3y > 4.642593, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_3y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 5y
mean(pheno_df_new$ocs_trim_totnum_5y, na.rm = T)
pheno_df_new$ocs_5y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_5y == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_5y > 0 & pheno_df_new$ocs_trim_totnum_5y <= 6.37963, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_5y > 6.37963, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_5y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 10y
mean(pheno_df_new$ocs_trim_totnum_10y, na.rm = T)
pheno_df_new$ocs_10y_cat <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_10y == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_10y > 0 & pheno_df_new$ocs_trim_totnum_10y <= 8.877778, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_10y > 8.877778, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_10y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

```


### 4.2.4 Definine OCS use (prospective) as 3 categories: noics, maybe, ics

Key: No ocs= ocs_totnum of 0  

     Maybe > 0 but <= mean
     
     Yes ocs => mean
     
```{r}
# within 1y
mean(pheno_df_new$ocs_trim_totnum_1y_after, na.rm = T)
pheno_df_new$ocs_1y_cat_after <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_1y_after == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_1y_after > 0 & pheno_df_new$ocs_trim_totnum_1y_after <= 1.810084, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_1y_after > 1.810084, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_1y_cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 2y
mean(pheno_df_new$ocs_trim_totnum_2y_after, na.rm = T)
pheno_df_new$ocs_2y_cat_after <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_2y_after == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_2y_after > 0 & pheno_df_new$ocs_trim_totnum_2y_after <= 3.369748, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_2y_after > 3.369748, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_2y_cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 3y
mean(pheno_df_new$ocs_trim_totnum_3y_after, na.rm = T)
pheno_df_new$ocs_3y_cat_after <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_3y_after == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_3y_after > 0 & pheno_df_new$ocs_trim_totnum_3y_after <= 4.963025, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_3y_after > 4.963025, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_3y_cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 5y
mean(pheno_df_new$ocs_trim_totnum_5y_after, na.rm = T)
pheno_df_new$ocs_5y_cat_after <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_5y_after == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_5y_after > 0 & pheno_df_new$ocs_trim_totnum_5y_after <= 7.166387, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_5y_after > 7.166387, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_5y_cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# within 10y
mean(pheno_df_new$ocs_trim_totnum_10y_after, na.rm = T)
pheno_df_new$ocs_10y_cat_after <- with(pheno_df_new, ifelse(pheno_df_new$asthma_num == 0, "NA",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_10y_after == 0, "noocs", 
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_10y_after > 0 & pheno_df_new$ocs_trim_totnum_10y_after <= 8.630252, "maybe",
                                                    ifelse(pheno_df_new$asthma_num == 1 & pheno_df_new$ocs_trim_totnum_10y_after > 8.630252, "ocs", "<NA>")))))
pheno_df_new[, .N, .(ocs_10y_cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

```

# 5. Association analysis (adjusted ICS use)
```{r}
save_manh_plot <- function(dat, title_infig, fig_name, wdth = 20, ht = 12, pointsize = 3, pointstroke = 1.5,
                           transparency = 1, if_lbl = c(T, F), lbl_thld = 2e-04) {
  
        p <- ggplot(dat, aes(x = feat_id, y = -log10(pval))) + 
                    facet_grid(. ~ denominator_sub_pathway, scales = "free_x") +  
                    geom_point(aes(color = numerator_sub_pathway , shape = direction_of_effect), 
                               size = pointsize, stroke = pointstroke, alpha = transparency) + 
                    scale_shape_manual(values = c("-" = 6, "+" = 2)) + 
                    labs(title = title_infig, 
                         y = expression('-log'[10]*'('*italic(P)*'-value)')) + 
                    theme(legend.position = "bottom", 
                          legend.text = element_text(size = 16), 
                          plot.title = element_text(hjust = 0.5, size = 20), 
                          strip.text.x = element_text(size = 16), 
                          axis.title.x = element_blank(),
                          axis.text.x = element_blank(), 
                          axis.ticks.x = element_blank(), 
                          axis.title.y = element_text(size = 16), 
                          axis.text.y = element_text(size = 16),
                          panel.border = element_blank(),
                          panel.grid.major = element_blank(),
                          panel.grid.minor = element_blank())
        if (if_lbl == T) {
                p <- p + geom_label_repel(aes(label = ifelse(pval < lbl_thld, CHEMICAL_NAME, "")),
                                          box.padding   = 0.25,
                                          point.padding = 0.5,
                                          segment.color = 'grey50',
                                          max.overlaps = 80)
        }
        ggsave(file = here(fig_dir, fig_name), plot = p, width = wdth, height = ht)
}


```

## 5.1 OCS use number in the prospective 5 years (exacerbation)
```{r}
# within 5 years
dat_tmp <- pheno_df_new[Asthma_Status == TRUE,]
dat_tmp$Biobank_Subject_ID <- as.character(dat_tmp$Biobank_Subject_ID)
dat_tmp$log_ige <- log(dat_tmp$ige)

ggplot(dat_tmp, aes(x=ocs_trim_totnum_5y)) + geom_histogram(color="darkblue", fill="lightblue")

## 3 categories
### No ocs= ocs_totnum of 0  
### Maybe > 0 but <= mean
### Yes ocs => mean
dat_tmp[, .N, .(ocs_5y_cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)
dat_tmp$ocs_5y_3cat <- with(dat_tmp, ifelse(ocs_5y_cat == "ocs", 1,
                                     ifelse(ocs_5y_cat == "noocs", 0, NA)))
dat_tmp[, .N, .(ocs_5y_3cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

# in prospective 5 years
ggplot(dat_tmp, aes(x=ocs_trim_totnum_5y_after)) + geom_histogram(color="darkblue", fill="lightblue")

## 3 categories
### No ocs= ocs_totnum of 0  
### Maybe > 0 but <= mean
### Yes ocs => mean
pheno_df_new[, .N, .(ocs_5y_cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)
dat_tmp$ocs_5y_3cat_after <- with(dat_tmp, ifelse(ocs_5y_cat_after == "ocs", 1,
                                           ifelse(ocs_5y_cat_after == "noocs", 0, NA)))
dat_tmp[, .N, .(ocs_5y_3cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

## clinical differences between ocs use and non-ocs use
dat_tmp$ics_5y_cat_f <- factor(dat_tmp$ics_5y_cat, levels = c("noics", "maybe", "ics"))

table1(~ Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y + ocs_trim_totnum_5y + ocs_trim_totnum_5y_after +
         ocs_5y_cat + eos + neut + baso + 
         FEV1_most_recent + FVC_most_recent + `FEV1/FVC_most_recent`| ics_5y_cat_f, data = dat_tmp, overall = T,
         extra.col=list(`P-value`=pvalue))

dat_tmp1 <- dat_tmp[ics_5y_cat != "maybe",]
table1(~ Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y + ocs_trim_totnum_5y + ocs_trim_totnum_5y_after + 
         ocs_5y_cat + eos + neut + baso +
         FEV1_most_recent + FVC_most_recent + `FEV1/FVC_most_recent`| ics_5y_cat_f, data = dat_tmp1, overall = T,
         extra.col=list(`P-value`=pvalue))

### the clinical difference between ocs use and non-ocs use (prospective)
dat_tmp[, .N, .(ocs_5y_3cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

dat_tmp$ocs_5y_3cat_after_f <- factor(dat_tmp$ocs_5y_3cat_after, levels = c("0", "1"))
dat_tmp[, .N, .(ocs_5y_3cat_after_f)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

table1(~ Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y + ocs_trim_totnum_5y + ocs_trim_totnum_5y_after +
         ocs_5y_cat + eos + neut + baso + log_ige +
         FEV1_most_recent + FVC_most_recent + `FEV1/FVC_most_recent`| ocs_5y_3cat_after_f, data = dat_tmp, overall = T,
         extra.col=list(`P-value`=pvalue))

ocs_correlation <- cor(dat_tmp$ocs_trim_totnum_5y, dat_tmp$ocs_trim_totnum_5y_after, use = "complete.obs", method = "spearman")
ocs_correlation_test <- cor.test(dat_tmp$ocs_trim_totnum_5y, dat_tmp$ocs_trim_totnum_5y_after, method = "spearman", use = "complete.obs")


## Cumulative Incidence plots
survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ 1, data = dat_tmp) %>% 
  ggsurvplot(conf.int = TRUE, 
             fun = "event", 
             risk.table = "abs_pct",
             ggtheme = theme_light(),
             surv.median.line = "hv")

## within the prospective 1 year, whether the patients has ocs use or not
dat_tmp$ocs_1y_asthma_after <- with(dat_tmp, ifelse(ocs_trim_totnum_1y_after == 0, 0,
                                             ifelse(ocs_trim_totnum_1y_after > 0, 1, NA)))
dat_tmp[, .N, .(ocs_1y_asthma_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

```


### 5.1.1 targeted sph/str * (no adj ocs use)
```{r}
list_analysis <- mets_missing_sph_str[mets_missing_sph_str$pct_na_met <= 0.3,"feat_id"]
length(list_analysis)

list_tmp <- append("Biobank_Subject_ID", list_analysis)
pheno_tmp <- merge(dat_tmp, df_sph_steroid_ratio_log[,..list_tmp], by = "Biobank_Subject_ID", all.x = T)

res_5.1.1 <- poiss_res_fnc(outc = "ocs_trim_totnum_5y_after", 
                           mets_list = list_analysis, 
                           dat = "pheno_tmp", 
                           add_covar = " + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y")

## Save results
res_ocs_trim_totnum_5y_after_sph_str_ratio <- res_5.1.1
res_ocs_trim_totnum_5y_after_sph_str_ratio <- res_ocs_trim_totnum_5y_after_sph_str_ratio %>% separate(feat_id, sep = "\\.", c("numerator", "denominator"), remove = F)

dict <- sph_mets_info[,c("feat_id", "SUB PATHWAY", "SUPER PATHWAY")]
res_ocs_trim_totnum_5y_after_sph_str_ratio$numerator_sub_pathway <- dict$`SUB PATHWAY`[match(res_ocs_trim_totnum_5y_after_sph_str_ratio$numerator, dict$feat_id)]

dict <- str_mets_info[,c("feat_id", "Component Name", "SUB PATHWAY", "SUPER PATHWAY")]
res_ocs_trim_totnum_5y_after_sph_str_ratio$denominator <- dict$`Component Name`[match(res_ocs_trim_totnum_5y_after_sph_str_ratio$denominator, dict$feat_id)]
res_ocs_trim_totnum_5y_after_sph_str_ratio$denominator_sub_pathway <- dict$`SUB PATHWAY`[match(res_ocs_trim_totnum_5y_after_sph_str_ratio$denominator, dict$`Component Name`)]

setcolorder(res_ocs_trim_totnum_5y_after_sph_str_ratio, c("feat_id", "numerator", "numerator_sub_pathway", "denominator", "denominator_sub_pathway"))

## display results
datatable(res_ocs_trim_totnum_5y_after_sph_str_ratio[fdr <= 0.05], 
          filter = "top") %>% 
          formatSignif(columns = c("beta", "pval", "fdr","se", "zval", "neg_log10_pval"), digits = 3) #453

```


### Elanstic net (no adj ocs) -- mean as cutoff
```{r}
optimal_output <- function(x, y, stp, nfold, lambda.min.ratio=1e-5, nlambda=500, model_switch=1, n_nopenalty=2, any_plot=1){
  alp = seq(0.1, 1, by=stp)
  optimal.lambda = c()
  max.AUC = c()
  num_nonzero = c()
  R.squared = c()
  model.output = list()
  
  for (i in alp) {
    if (model_switch==1) {
      model_cv <- cv.glmnet(x, y, nfolds=nfold, alpha=i, family = "binomial", 
                            type.measure = "auc", standardize = T, keep = TRUE, 
                            lambda.min.ratio=lambda.min.ratio, nlambda=nlambda)
    } else if (model_switch==2){
      model_cv <- cv.glmnet(x, y, nfolds=nfold, alpha=i, family = "binomial", 
                            type.measure = "auc", standardize = T, keep = TRUE, 
                            lambda.min.ratio=lambda.min.ratio, nlambda=nlambda,
                            penalty.factor=c(rep(1,n_nopenalty), rep(0,ncol(x)-n_nopenalty))
                            ) 
    }
    
    model.output[[i/stp]] = model_cv
    optimal.lambda = c(optimal.lambda, round(model_cv$lambda.min, digits=4))
    max.AUC = c(max.AUC, round(max(model_cv$cvm), digits = 4))
    num_nonzero = c(num_nonzero, model_cv$nzero[model_cv$index[1]])
    R.squared = c(R.squared, round(model_cv$glmnet.fit$dev.ratio[model_cv$index[1]], digits = 4))
  }
  
  model.stats <- data.table(alp=alp, optimal.lambda=optimal.lambda, max.AUC=max.AUC,  num_nonzero=num_nonzero, R.squared=R.squared)
  alp_opt <- model.stats[max.AUC==max(max.AUC)]$alp
  
  model.opt <- model.output[[alp_opt/stp]]
  print(paste0("alpha: ", alp_opt))
  print(paste0("optimal lambda: ", round(model.opt$lambda.min, digits=4)))
  print(paste0("max AUC: ", round(max(model.opt$cvm), digits = 4)))
  print(paste0("# of nonzero features at min MSE: ", model.opt$nzero[model.opt$index[1]]))
  print(paste0("R-square: ", round(model.opt$glmnet.fit$dev.ratio[model.opt$index[1]], digits = 4)))
  
  if (any_plot == 1) plot(model.opt) 
  
  return(model.opt)
}
```

#### 1. results
```{r}
##########################logistic elastic net#################################
## 3 categories
### No ocs= ocs_totnum of 0  
### Maybe > 0 but <= mean
### Yes ocs => mean

## only focus low OCS and high OCS
sig_feat <- res_5.1.1[fdr <= 0.05, feat_id] #453
sig_column <- c("Age_at_Collection", "bmi", "Gender", "race", "Ethnicity", "ics_trim_totnum_5y", "ocs_5y_3cat_after", sig_feat)

x = pheno_tmp[, ..sig_column] # n = 540

x_new <- x
x_new$Gender <- as.factor(x_new$Gender)
x_new$race <- as.factor(x_new$race)
x_new$Ethnicity <- with(x_new, ifelse(Ethnicity != "Hispanic", "Non-Hispanic", "Hispanic"))
x_new$Ethnicity <- as.factor(x_new$Ethnicity)

x_new <- x_new[complete_cases(x_new),] # n = 174

x_new <- one_hot(x_new, cols = c("Gender", "race", "Ethnicity"), sparsifyNAs = FALSE, naCols = FALSE,
  dropCols = TRUE, dropUnusedLevels = FALSE)

y = x_new$ocs_5y_3cat_after
x_new_subjectID <- x_new$Biobank_Subject_ID

x_new[, .N, .(ocs_5y_3cat_after)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

x_new_df <- x_new

x_new <- x_new[,-c("ocs_5y_3cat_after")]
x_new_1 <- x_new[,-c("Gender_M", "race_Other", "Ethnicity_Hispanic", "Ethnicity_Non-Hispanic")]

x_new <- as.matrix(x_new)
x_new_1 <- as.matrix(x_new_1)

set.seed(35656) # reproducible random numbers
# seed_num <- sample(1:50000, 20, replace=F)
# seed_num <- c(10904, 33373, 9986, 75, 30311, 26378, 21415, 46366, 25548, 35656, 31756, 393, 44685, 23700, 8784, 28128, 21052, 2848, 40996, 12345)
# 10904 33373  9986    75 30311 26378 21415 46366 25548 35656 31756   393 44685 23700  8784 28128 21052  2848 40996 13961

# for (i in 1:20) {
#   print(paste0("seed number: ", seed_num[i]))
#   set.seed(seed_num[i])
#   elas_net_5.1.1_test <- optimal_output(x_new_1, y, stp=0.1, nfold=10, model_switch = 1)
#   cat('\n')
# }

# [1] "seed number: 40996"
# [1] "alpha: 0.6"
# [1] "optimal lambda: 0.0587"
# [1] "max AUC: 0.7501"
# [1] "# of nonzero features at min MSE: 15"
# [1] "R-square: 0.1428"

# [1] "seed number: 35656"
# [1] "alpha: 0.7"
# [1] "optimal lambda: 0.0634"
# [1] "max AUC: 0.7517"
# [1] "# of nonzero features at min MSE: 11"
# [1] "R-square: 0.133"

# [1] "seed number: 10904"
# [1] "alpha: 0.7"
# [1] "optimal lambda: 0.0527"
# [1] "max AUC: 0.7407"
# [1] "# of nonzero features at min MSE: 10"
# [1] "R-square: 0.1421"

elas_net_5.1.1 <- optimal_output(x_new_1, y, stp=0.1, nfold=10, model_switch = 1)
# elas_net_5.5.5_1 <- readRDS("/Users/yuluchen/Dropbox (Partners HealthCare)/Personal/PEGASUS/global_metabolome/results/12/5/elas_net_5.5.5_1.rds")

# [1] "alpha: 0.7"
# [1] "optimal lambda: 0.0634"
# [1] "max AUC: 0.7517"
# [1] "# of nonzero features at min MSE: 11"
# [1] "R-square: 0.133"

betas <- elas_net_5.1.1$glmnet.fit$beta[,elas_net_5.1.1$index[1]]
betas <- data.table(param=names(betas), beta=round(betas,digits = 4))

beta_5.1.1 <- betas[beta!=0]
beta_5.1.1 <- beta_5.1.1 %>% separate(param, sep = "\\.", c("numerator", "denominator"), remove = F)

dict <- sph_mets_info[,c("feat_id", "SUB PATHWAY", "SUPER PATHWAY")]
beta_5.1.1$numerator_sub_pathway <- dict$`SUB PATHWAY`[match(beta_5.1.1$numerator, dict$feat_id)]

dict <- str_mets_info[,c("feat_id", "Component Name", "SUB PATHWAY", "SUPER PATHWAY")]
beta_5.1.1$denominator <- dict$`Component Name`[match(beta_5.1.1$denominator, dict$feat_id)]
beta_5.1.1$denominator_sub_pathway <- dict$`SUB PATHWAY`[match(beta_5.1.1$denominator, dict$`Component Name`)]

setcolorder(beta_5.1.1, c("param", "numerator", "numerator_sub_pathway", "denominator", "denominator_sub_pathway"))

beta_5.1.1
#                       param   numerator numerator_sub_pathway                    denominator denominator_sub_pathway   beta
#  1:              race_Black  race_Black                  <NA>                           <NA>                    <NA> 0.1937
#  2:   LacCer18_1.S8_steroid  LacCer18_1       Hex/LacCeramide                      cortisone         glucocorticoids 0.1107
#  3:  SM18_1d18_1.S8_steroid SM18_1d18_1         Sphingomyelin                      cortisone         glucocorticoids 0.0871
#  4:   HexCer18_1.S8_steroid  HexCer18_1       Hex/LacCeramide                      cortisone         glucocorticoids 0.0826
#  5:   DhCer16_0.S10_steroid   DhCer16_0       Dihydroceramide dehydroepiandrosterone sulfate               androgens 0.0086
#  6: SM18_1d18_1.S10_steroid SM18_1d18_1         Sphingomyelin dehydroepiandrosterone sulfate               androgens 0.0196
#  7:  LacCer18_1.S10_steroid  LacCer18_1       Hex/LacCeramide dehydroepiandrosterone sulfate               androgens 0.0124
#  8:  LacCer16_0.S10_steroid  LacCer16_0       Hex/LacCeramide dehydroepiandrosterone sulfate               androgens 0.0010
#  9:   LacCer12_0.S8_steroid  LacCer12_0       Hex/LacCeramide                      cortisone         glucocorticoids 0.0906
# 10:  LacCer12_0.S10_steroid  LacCer12_0       Hex/LacCeramide dehydroepiandrosterone sulfate               androgens 0.0574
# 11:    DhCer16_0.S4_steroid   DhCer16_0       Dihydroceramide                    aldosterone      mineralocorticoids 0.1225

head(coef(elas_net_5.1.1, s = 0.0634)) # s equal to the optimal lambda
#                          s1
# (Intercept)       -1.593766
# Age_at_Collection  .       
# bmi                .       
# Gender_F           .       
# race_Black         0.420780
# race_White         .       

rocs <- roc.glmnet(elas_net_5.1.1$fit.preval, newy = y)
best <- elas_net_5.1.1$index["min",]
plot(rocs[[best]], type = "l")
invisible(sapply(rocs, lines, col="grey"))
lines(rocs[[best]], lwd = 2,col = "red")

prob_predictions <- predict(elas_net_5.1.1$glmnet.fit, newx = x_new_1, s = 0.0634, type="response")
roc_obj <- roc(y, as.vector(prob_predictions))

ggroc_obj <- data.frame(
  FPR = roc_obj$specificities,
  TPR = roc_obj$sensitivities
)

ggplot(ggroc_obj, aes(x = 1 - FPR, y = TPR)) +
  geom_line(color = "red") +
  labs(x = "Sensitivity", y = "1 - Specificity", title = "ROC Curve") +
  theme_minimal() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black")

elas_net_5.1.1_res <- data.frame(c(1:472), elas_net_5.1.1$lambda, elas_net_5.1.1$cvm, elas_net_5.1.1$nzero)

## display results
datatable(elas_net_5.1.1_res, 
          filter = "top")

## logistic prediction (previous ocs)
selected_x <- beta_5.1.1$param
selected_x <- selected_x[-1]
selected_x <- c("race", selected_x)
selected_x_y <- c(selected_x, "ocs_5y_3cat_after")

selected_ratio <- selected_x[-c(1)]

tmp <- pheno_tmp[,..selected_x_y]

# Standardize data
tmp[, (selected_ratio) := lapply(.SD, function(x) scale(x, center = T, scale = T)), .SDcols = selected_ratio]

fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")
summary(fit)$coefficients
#                            Estimate Std. Error    z value   Pr(>|z|)
# (Intercept)              0.74591689  0.6436170  1.1589452 0.24647851
# raceOther               -0.17790962  0.7505883 -0.2370269 0.81263591
# raceWhite               -0.45984214  0.6719679 -0.6843216 0.49377213
# LacCer18_1.S8_steroid    0.71463257  0.6703687  1.0660291 0.28641049
# SM18_1d18_1.S8_steroid  -0.09008268  0.7267250 -0.1239570 0.90134929
# HexCer18_1.S8_steroid   -0.17378973  0.4739945 -0.3666492 0.71388068
# DhCer16_0.S10_steroid    0.17588669  0.4093475  0.4296757 0.66743157
# SM18_1d18_1.S10_steroid  1.25373102  0.9075000  1.3815217 0.16711860
# LacCer16_0.S10_steroid  -1.13583929  0.9382376 -1.2106095 0.22604511
# LacCer12_0.S8_steroid    0.49986840  0.2645533  1.8894812 0.05882739
# DhCer16_0.S4_steroid     0.26023673  0.1775206  1.4659519 0.14266139

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(tmp$ocs_5y_3cat_after, probs)
auc(roc_obj) #0.7613

## logistic prediction (previous ocs)
selected_x_y <- c(selected_x, "ocs_5y_3cat")
tmp <- pheno_tmp[,..selected_x_y]

# Standardize data
tmp[, (selected_ratio) := lapply(.SD, function(x) scale(x, center = T, scale = T)), .SDcols = selected_ratio]

fit <- glm(ocs_5y_3cat ~ ., data = tmp, family = "binomial")
summary(fit)$coefficients
#                            Estimate Std. Error     z value  Pr(>|z|)
# (Intercept)              0.13837931  0.4969488  0.27845790 0.7806609
# raceOther                0.63635771  0.6124425  1.03904894 0.2987820
# raceWhite               -0.22257951  0.5175267 -0.43008312 0.6671352
# LacCer18_1.S8_steroid    0.04245140  0.6088837  0.06972005 0.9444165
# SM18_1d18_1.S8_steroid   0.35517394  0.6729332  0.52779973 0.5976383
# HexCer18_1.S8_steroid    0.20757324  0.3873431  0.53588984 0.5920347
# DhCer16_0.S10_steroid    0.15141543  0.3682140  0.41121588 0.6809142
# SM18_1d18_1.S10_steroid  0.34725182  0.7667204  0.45290545 0.6506168
# LacCer16_0.S10_steroid  -0.02381452  0.7626997 -0.03122398 0.9750909
# LacCer12_0.S8_steroid   -0.03853651  0.2287917 -0.16843489 0.8662412
# DhCer16_0.S4_steroid    -0.07009566  0.1512242 -0.46352158 0.6429906

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(tmp$ocs_5y_3cat, probs)
auc(roc_obj) #0.7219
```

## 5.2 OCS use number within the last 5 years (exacerbation)
### 5.2.1 targeted sph/str * (no adj ocs use)
```{r}
list_analysis <- mets_missing_sph_str[mets_missing_sph_str$pct_na_met <= 0.3,"feat_id"]
length(list_analysis)

list_tmp <- append("Biobank_Subject_ID", list_analysis)
pheno_tmp <- merge(dat_tmp, df_sph_steroid_ratio_log[,..list_tmp], by = "Biobank_Subject_ID", all.x = T)

res_5.2.1 <- poiss_res_fnc(outc = "ocs_trim_totnum_5y", 
                           mets_list = list_analysis, 
                           dat = "pheno_tmp", 
                           add_covar = " + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y")

## Save results
res_ocs_trim_totnum_5y_sph_str_ratio <- res_5.2.1
res_ocs_trim_totnum_5y_sph_str_ratio <- res_ocs_trim_totnum_5y_sph_str_ratio %>% separate(feat_id, sep = "\\.", c("numerator", "denominator"), remove = F)

dict <- sph_mets_info[,c("feat_id", "SUB PATHWAY", "SUPER PATHWAY")]
res_ocs_trim_totnum_5y_sph_str_ratio$numerator_sub_pathway <- dict$`SUB PATHWAY`[match(res_ocs_trim_totnum_5y_sph_str_ratio$numerator, dict$feat_id)]

dict <- str_mets_info[,c("feat_id", "Component Name", "SUB PATHWAY", "SUPER PATHWAY")]
res_ocs_trim_totnum_5y_sph_str_ratio$denominator <- dict$`Component Name`[match(res_ocs_trim_totnum_5y_sph_str_ratio$denominator, dict$feat_id)]
res_ocs_trim_totnum_5y_sph_str_ratio$denominator_sub_pathway <- dict$`SUB PATHWAY`[match(res_ocs_trim_totnum_5y_sph_str_ratio$denominator, dict$`Component Name`)]

setcolorder(res_ocs_trim_totnum_5y_sph_str_ratio, c("feat_id", "numerator", "numerator_sub_pathway", "denominator", "denominator_sub_pathway"))

## display results
datatable(res_ocs_trim_totnum_5y_sph_str_ratio[fdr <= 0.05], 
          filter = "top") %>% 
          formatSignif(columns = c("beta", "pval", "fdr","se", "zval", "neg_log10_pval"), digits = 3) #748

```


### Elanstic net (no adj ocs) -- mean as cutoff
#### 1. results
```{r}
##########################logistic elastic net#################################
## 3 categories
### No ocs= ocs_totnum of 0  
### Maybe > 0 but <= mean
### Yes ocs => mean

## only focus low OCS and high OCS
sig_feat <- res_5.2.1[fdr <= 0.05, feat_id] #748
sig_column <- c("Age_at_Collection", "bmi", "Gender", "race", "Ethnicity", "ics_trim_totnum_5y", "ocs_5y_3cat", sig_feat)

x = pheno_tmp[, ..sig_column] # n = 540

x_new <- x
x_new$Gender <- as.factor(x_new$Gender)
x_new$race <- as.factor(x_new$race)
x_new$Ethnicity <- with(x_new, ifelse(Ethnicity != "Hispanic", "Non-Hispanic", "Hispanic"))
x_new$Ethnicity <- as.factor(x_new$Ethnicity)

x_new <- x_new[complete_cases(x_new),] # n = 234

x_new <- one_hot(x_new, cols = c("Gender", "race", "Ethnicity"), sparsifyNAs = FALSE, naCols = FALSE,
  dropCols = TRUE, dropUnusedLevels = FALSE)

y = x_new$ocs_5y_3cat
x_new_subjectID <- x_new$Biobank_Subject_ID

x_new[, .N, .(ocs_5y_3cat)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

x_new_df <- x_new

x_new <- x_new[,-c("ocs_5y_3cat")]
x_new_1 <- x_new[,-c("Gender_M", "race_Other", "Ethnicity_Hispanic", "Ethnicity_Non-Hispanic")]

x_new <- as.matrix(x_new)
x_new_1 <- as.matrix(x_new_1)

# seed_num <- sample(1:50000, 20, replace=F)
# seed_num <- c(10904, 33373, 9986, 75, 30311, 26378, 21415, 46366, 25548, 35656, 31756, 393, 44685, 23700, 8784, 28128, 21052, 2848, 40996, 12345)
# 10904 33373  9986    75 30311 26378 21415 46366 25548 35656 31756   393 44685 23700  8784 28128 21052  2848 40996 13961

# for (i in 1:20) {
#   print(paste0("seed number: ", seed_num[i]))
#   set.seed(seed_num[i])
#   elas_net_5.2.1_test <- optimal_output(x_new_1, y, stp=0.1, nfold=10, model_switch = 1)
#   cat('\n')
# }

# [1] "seed number: 35656"
# [1] "alpha: 0.6"
# [1] "optimal lambda: 0.0602"
# [1] "max AUC: 0.7735"
# [1] "# of nonzero features at min MSE: 23"
# [1] "R-square: 0.1795"

# [1] "seed number: 393"
# [1] "alpha: 0.4"
# [1] "optimal lambda: 0.0733"
# [1] "max AUC: 0.774"
# [1] "# of nonzero features at min MSE: 32"
# [1] "R-square: 0.1908"

set.seed(35656) # reproducible random numbers
elas_net_5.2.1 <- optimal_output(x_new_1, y, stp=0.1, nfold=10, model_switch = 1)
# elas_net_5.5.5_1 <- readRDS("/Users/yuluchen/Dropbox (Partners HealthCare)/Personal/PEGASUS/global_metabolome/results/12/5/elas_net_5.5.5_1.rds")

# [1] "alpha: 0.6"
# [1] "optimal lambda: 0.0602"
# [1] "max AUC: 0.7735"
# [1] "# of nonzero features at min MSE: 23"
# [1] "R-square: 0.1795"

betas <- elas_net_5.2.1$glmnet.fit$beta[,elas_net_5.2.1$index[1]]
betas <- data.table(param=names(betas), beta=round(betas,digits = 4))

beta_5.2.1 <- betas[beta!=0]
beta_5.2.1 <- beta_5.2.1 %>% separate(param, sep = "\\.", c("numerator", "denominator"), remove = F)

dict <- sph_mets_info[,c("feat_id", "SUB PATHWAY", "SUPER PATHWAY")]
beta_5.2.1$numerator_sub_pathway <- dict$`SUB PATHWAY`[match(beta_5.2.1$numerator, dict$feat_id)]

dict <- str_mets_info[,c("feat_id", "Component Name", "SUB PATHWAY", "SUPER PATHWAY")]
beta_5.2.1$denominator <- dict$`Component Name`[match(beta_5.2.1$denominator, dict$feat_id)]
beta_5.2.1$denominator_sub_pathway <- dict$`SUB PATHWAY`[match(beta_5.2.1$denominator, dict$`Component Name`)]

setcolorder(beta_5.2.1, c("param", "numerator", "numerator_sub_pathway", "denominator", "denominator_sub_pathway"))

beta_5.2.1

head(coef(elas_net_5.2.1, s = 0.0602)) # s equal to the optimal lambda
#                           s1
# (Intercept)        0.2121086
# Age_at_Collection  .        
# bmi                .        
# Gender_F           .        
# race_Black         .        
# race_White        -0.1973034

rocs <- roc.glmnet(elas_net_5.2.1$fit.preval, newy = y)
best <- elas_net_5.2.1$index["min",]
plot(rocs[[best]], type = "l")
invisible(sapply(rocs, lines, col="grey"))
lines(rocs[[best]], lwd = 2,col = "red")

prob_predictions <- predict(elas_net_5.2.1$glmnet.fit, newx = x_new_1, s = 0.0602, type="response")
roc_obj <- roc(y, as.vector(prob_predictions))

ggroc_obj <- data.frame(
  FPR = roc_obj$specificities,
  TPR = roc_obj$sensitivities
)

ggplot(ggroc_obj, aes(x = 1 - FPR, y = TPR)) +
  geom_line(color = "red") +
  labs(x = "Sensitivity", y = "1 - Specificity", title = "ROC Curve") +
  theme_minimal() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black")

elas_net_5.2.1_res <- data.frame(c(1:361), elas_net_5.2.1$lambda, elas_net_5.2.1$cvm, elas_net_5.2.1$nzero)

## display results
datatable(elas_net_5.2.1_res, 
          filter = "top")

## logistic prediction (previous ocs)
selected_x <- beta_5.2.1$param
selected_x <- selected_x[-1]
selected_x <- c("race", selected_x)
selected_x_y <- c(selected_x, "ocs_5y_3cat")

selected_ratio <- selected_x[-c(1:2)]

tmp <- pheno_tmp[,..selected_x_y]

# Standardize data
tmp[, (selected_ratio) := lapply(.SD, function(x) scale(x, center = T, scale = T)), .SDcols = selected_ratio]

fit <- glm(ocs_5y_3cat ~ ., data = tmp, family = "binomial")
summary(fit)$coefficients
#                             Estimate Std. Error    z value     Pr(>|z|)
# (Intercept)              -0.16669893 0.59836079 -0.2785927 0.7805574459
# raceOther                 0.30186319 0.72760456  0.4148726 0.6782351768
# raceWhite                -0.56567824 0.62481552 -0.9053524 0.3652787215
# ics_trim_totnum_5y        0.04705841 0.01280436  3.6751865 0.0002376757
# Cer20_1d18_1.S10_steroid -0.29063086 0.86157239 -0.3373261 0.7358710813
# Cer20_0d18_1.S10_steroid  0.84333959 0.88039204  0.9579137 0.3381062801
# Cer26_1d18_1.S10_steroid  0.27481283 0.66279966  0.4146243 0.6784169783
# SM20_d18_1.S10_steroid   -1.33785981 1.15859626 -1.1547248 0.2482031495
# Cer20_1d18_1.S8_steroid   0.09085247 0.54491610  0.1667274 0.8675845075
# Spad18_0.S10_steroid      1.16817404 1.06358292  1.0983385 0.2720567173
# HexCer24_1.S8_steroid     0.55338968 0.45154317  1.2255521 0.2203672796
# Sph18_1.S10_steroid      -0.30309738 0.75390256 -0.4020379 0.6876561537
# Cer20_1d18_1.S6_steroid   0.99320869 0.29131361  3.4094140 0.0006510260
# LacCer12_0.S1_steroid     0.06830953 0.26383089  0.2589141 0.7957015288
# Cer24_1d16_1.S1_steroid  -0.33122389 0.87198624 -0.3798499 0.7040568375
# Cer24_1d18_2.S1_steroid  -0.26400711 0.50064934 -0.5273294 0.5979648688
# SM16_0d16_1.S1_steroid    0.29292617 0.67640285  0.4330647 0.6649677908
# Cer17_0d18_1.S1_steroid  -0.77535724 0.42775032 -1.8126398 0.0698874027

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(tmp$ocs_5y_3cat, probs)
auc(roc_obj) #0.8246

## logistic prediction (prospective ocs)
selected_x_y <- c(selected_x, "ocs_5y_3cat_after")
tmp <- pheno_tmp[,..selected_x_y]

# Standardize data
tmp[, (selected_ratio) := lapply(.SD, function(x) scale(x, center = T, scale = T)), .SDcols = selected_ratio]

fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")
summary(fit)$coefficients
#                              Estimate Std. Error    z value    Pr(>|z|)
# (Intercept)               0.617839806 0.69092104  0.8942264 0.371200792
# raceOther                -0.439237074 0.81361262 -0.5398602 0.589293447
# raceWhite                -0.288266989 0.70795901 -0.4071803 0.683875544
# ics_trim_totnum_5y       -0.002662579 0.01203974 -0.2211493 0.824976205
# Cer20_1d18_1.S10_steroid -0.716734456 0.95738737 -0.7486358 0.454076750
# Cer20_0d18_1.S10_steroid  0.901282478 0.97693961  0.9225570 0.356238114
# Cer26_1d18_1.S10_steroid  2.388290653 0.84256943  2.8345328 0.004589275
# SM20_d18_1.S10_steroid   -3.589044826 1.42372998 -2.5208747 0.011706354
# Cer20_1d18_1.S8_steroid   2.165462472 0.71227840  3.0401911 0.002364280
# Spad18_0.S10_steroid      2.262983427 1.16142893  1.9484476 0.051361427
# HexCer24_1.S8_steroid    -0.811015682 0.56553711 -1.4340627 0.151554364
# Sph18_1.S10_steroid      -1.016797883 0.76664371 -1.3262978 0.184741065
# Cer20_1d18_1.S6_steroid  -0.109477969 0.32609069 -0.3357286 0.737075543
# LacCer12_0.S1_steroid     0.748741158 0.29272819  2.5578034 0.010533562
# Cer24_1d16_1.S1_steroid  -3.531731972 1.07405568 -3.2882206 0.001008228
# Cer24_1d18_2.S1_steroid   0.425016998 0.55013567  0.7725676 0.439778318
# SM16_0d16_1.S1_steroid    2.695108721 0.86335967  3.1216523 0.001798392
# Cer17_0d18_1.S1_steroid  -0.386017262 0.49310220 -0.7828342 0.433724485

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(tmp$ocs_5y_3cat, probs)
auc(roc_obj) #0.7927
```

### plot ROC final
```{r}
# Create ROC curve objects and Extract coordinates of the ROC curves

## prospective ocs use: ics use + race, logistic -- AUC=0.4977
selected_x_y <- c("race", "ics_trim_totnum_5y",
                  "ocs_5y_3cat_after")
tmp <- pheno_tmp[,..selected_x_y]
fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(pheno_tmp$ocs_5y_3cat_after, probs)
auc(roc_obj) #0.4977
roc1 <- roc(pheno_tmp$ocs_5y_3cat_after, probs, smooth=T, smooth.n=200)

roc1_df <- data.frame(
  sensitivity = roc1$sensitivities,
  specificity = 1 - roc1$specificities,  # ggplot requires 1 - specificity
  model = 'incident exacerbation ~ Race + ICS'
)

## prospective ocs use: IgE + race, logistic -- AUC=0.5963
selected_x_y <- c("race", "log_ige",
                  "ocs_5y_3cat_after")
tmp <- pheno_tmp[,..selected_x_y]
fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(pheno_tmp$ocs_5y_3cat_after, probs)
auc(roc_obj) #0.5965
roc2 <- roc(pheno_tmp$ocs_5y_3cat_after, probs, smooth=T, smooth.n=200)

roc2_df <- data.frame(
  sensitivity = roc2$sensitivities,
  specificity = 1 - roc2$specificities,  # ggplot requires 1 - specificity
  model = 'incident exacerbation ~ Race + IgE'
)

## prospective ocs use: IgE + ics use + race, logistic -- AUC=0.5752
selected_x_y <- c("race", "ics_trim_totnum_5y", "log_ige",
                  "ocs_5y_3cat_after")
tmp <- pheno_tmp[,..selected_x_y]
fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(pheno_tmp$ocs_5y_3cat_after, probs)
auc(roc_obj) #0.5752
roc3 <- roc(pheno_tmp$ocs_5y_3cat_after, probs, smooth=T, smooth.n=200)

roc3_df <- data.frame(
  sensitivity = roc3$sensitivities,
  specificity = 1 - roc3$specificities,  # ggplot requires 1 - specificity
  model = 'incident exacerbation ~ Race + ICS + IgE'
)

## prospective ocs use: ics use + race + 21 ratios, logistic -- AUC=0.7927
selected_x_y <- c("race", "ics_trim_totnum_5y", 
                  "Cer20_1d18_1.S10_steroid", "Cer20_0d18_1.S10_steroid", "Cer26_1d18_1.S10_steroid", "SM20_d18_1.S10_steroid",
                  "Cer20_1d18_1.S8_steroid", "Spad18_0.S10_steroid", "Cer26_1d18_1.S8_steroid", "HexCer24_1.S8_steroid",
                  "Sph18_1.S10_steroid", "SM20_d18_1.S8_steroid", "Spad18_0.S8_steroid", "Cer20_1d18_1.S6_steroid", 
                  "Cer26_1d18_1.S6_steroid", "HexCer24_1.S6_steroid", "SM20_d18_1.S6_steroid", "Spad18_0.S6_steroid", 
                  "LacCer12_0.S1_steroid", "Cer24_1d16_1.S1_steroid", "Cer24_1d18_2.S1_steroid", "SM16_0d16_1.S1_steroid", 
                  "Cer17_0d18_1.S1_steroid",  
                  "ocs_5y_3cat_after")
selected_ratio <- c("Cer20_1d18_1.S10_steroid", "Cer20_0d18_1.S10_steroid", "Cer26_1d18_1.S10_steroid", "SM20_d18_1.S10_steroid",
                  "Cer20_1d18_1.S8_steroid", "Spad18_0.S10_steroid", "Cer26_1d18_1.S8_steroid", "HexCer24_1.S8_steroid",
                  "Sph18_1.S10_steroid", "SM20_d18_1.S8_steroid", "Spad18_0.S8_steroid", "Cer20_1d18_1.S6_steroid", 
                  "Cer26_1d18_1.S6_steroid", "HexCer24_1.S6_steroid", "SM20_d18_1.S6_steroid", "Spad18_0.S6_steroid", 
                  "LacCer12_0.S1_steroid", "Cer24_1d16_1.S1_steroid", "Cer24_1d18_2.S1_steroid", "SM16_0d16_1.S1_steroid", 
                  "Cer17_0d18_1.S1_steroid")
tmp <- pheno_tmp[,..selected_x_y]

# Standardize data
tmp[, (selected_ratio) := lapply(.SD, function(x) scale(x, center = T, scale = T)), .SDcols = selected_ratio]

fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(tmp$ocs_5y_3cat_after, probs)
auc(roc_obj) #0.7927
roc4 <- roc(pheno_tmp$ocs_5y_3cat_after, probs, smooth=T, smooth.n=200)

roc4_df <- data.frame(
  sensitivity = roc4$sensitivities,
  specificity = 1 - roc4$specificities,  # ggplot requires 1 - specificity
  model = 'incident exacerbation ~ Race + ICS + 21 ratios'
)


## prospective ocs use: ics use + race + 21 ratios, logistic -- AUC=0.7927
selected_x_y <- c("race", "ics_trim_totnum_5y", "log_ige",
                  "Cer20_1d18_1.S10_steroid", "Cer20_0d18_1.S10_steroid", "Cer26_1d18_1.S10_steroid", "SM20_d18_1.S10_steroid",
                  "Cer20_1d18_1.S8_steroid", "Spad18_0.S10_steroid", "Cer26_1d18_1.S8_steroid", "HexCer24_1.S8_steroid",
                  "Sph18_1.S10_steroid", "SM20_d18_1.S8_steroid", "Spad18_0.S8_steroid", "Cer20_1d18_1.S6_steroid", 
                  "Cer26_1d18_1.S6_steroid", "HexCer24_1.S6_steroid", "SM20_d18_1.S6_steroid", "Spad18_0.S6_steroid", 
                  "LacCer12_0.S1_steroid", "Cer24_1d16_1.S1_steroid", "Cer24_1d18_2.S1_steroid", "SM16_0d16_1.S1_steroid", 
                  "Cer17_0d18_1.S1_steroid",  
                  "ocs_5y_3cat_after")
selected_ratio <- c("Cer20_1d18_1.S10_steroid", "Cer20_0d18_1.S10_steroid", "Cer26_1d18_1.S10_steroid", "SM20_d18_1.S10_steroid",
                  "Cer20_1d18_1.S8_steroid", "Spad18_0.S10_steroid", "Cer26_1d18_1.S8_steroid", "HexCer24_1.S8_steroid",
                  "Sph18_1.S10_steroid", "SM20_d18_1.S8_steroid", "Spad18_0.S8_steroid", "Cer20_1d18_1.S6_steroid", 
                  "Cer26_1d18_1.S6_steroid", "HexCer24_1.S6_steroid", "SM20_d18_1.S6_steroid", "Spad18_0.S6_steroid", 
                  "LacCer12_0.S1_steroid", "Cer24_1d16_1.S1_steroid", "Cer24_1d18_2.S1_steroid", "SM16_0d16_1.S1_steroid", 
                  "Cer17_0d18_1.S1_steroid")
tmp <- pheno_tmp[,..selected_x_y]

# Standardize data
tmp[, (selected_ratio) := lapply(.SD, function(x) scale(x, center = T, scale = T)), .SDcols = selected_ratio]

fit <- glm(ocs_5y_3cat_after ~ ., data = tmp, family = "binomial")

probs <- predict(fit, newdata = tmp, type = "response")
roc_obj <- roc(tmp$ocs_5y_3cat_after, probs)
auc(roc_obj) #0.9012
roc5 <- roc(pheno_tmp$ocs_5y_3cat_after, probs, smooth=T, smooth.n=200)

roc5_df <- data.frame(
  sensitivity = roc5$sensitivities,
  specificity = 1 - roc5$specificities,  # ggplot requires 1 - specificity
  model = 'incident exacerbation ~ Race + ICS + IgE + 21 ratios'
)


# Combine the data frames
roc_df <- rbind(roc1_df, roc3_df, roc4_df, roc5_df)

roc_df$model <- factor(roc_df$model, levels = c("incident exacerbation ~ Race + ICS",
                                                "incident exacerbation ~ Race + ICS + IgE",
                                                "incident exacerbation ~ Race + ICS + 21 ratios",
                                                "incident exacerbation ~ Race + ICS + IgE + 21 ratios"
                                                ))


# Plot using ggplot2 with smoothing
png(file=str_c(fig_dir, "PEGASUS_roc_plot_final.png"), width = 6, height = 6, units = "in", res = 300)
ggplot(roc_df, aes(x = specificity, y = sensitivity, color = model)) +
  geom_point(alpha = 0.2) +  # Optional: add points; make them slightly transparent
  geom_line() +
  labs(x = "1 - Specificity", y = "Sensitivity") +
  theme_minimal() + coord_fixed(ratio = 1) +
  theme(legend.position = "bottom",legend.box = "horizontal") +
  guides(color = guide_legend(nrow = 4, byrow = TRUE)) + 
  scale_color_manual(values = c("incident exacerbation ~ Race + ICS" = "#C77CFF",
                                "incident exacerbation ~ Race + ICS + IgE" = "#7CAE00",
                                "incident exacerbation ~ Race + ICS + 21 ratios" = "#00BFC4",
                                "incident exacerbation ~ Race + ICS + IgE + 21 ratios" = "#F8766D"))  # Set the colors manually
dev.off()



# Combine the data frames
roc_df <- rbind(roc2_df, roc4_df, roc7_df)

roc_df$model <- factor(roc_df$model, levels = c("previous ocs use ~ ics use + race + 21 ratios",
                                                "prospective ocs use ~ ics use + race + 21 ratios",
                                                "prospective ocs use ~ ics use + race"))


# Plot using ggplot2 with smoothing
png(file=str_c(fig_dir, "PEGASUS_roc_plot.png"), width = 6, height = 6, units = "in", res = 300)
ggplot(roc_df, aes(x = specificity, y = sensitivity, color = model)) +
  geom_point(alpha = 0.2) +  # Optional: add points; make them slightly transparent
  geom_line() +
  labs(x = "Specificity", y = "Sensitivity") +
  theme_minimal() + coord_fixed(ratio = 1) +
  theme(legend.position = "bottom",legend.box = "horizontal") +
  guides(color = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_color_manual(values = c("previous ocs use ~ ics use + race + 21 ratios" = "#F8766D", 
                                "prospective ocs use ~ ics use + race + 21 ratios" = "#00BA38",
                                "prospective ocs use ~ ics use + race" = "#619CFF"))  # Set the colors manually
dev.off()

# Combine the data frames
roc_df <- rbind(roc2_df, roc4_df, roc7_df, roc19_df)

roc_df$model <- factor(roc_df$model, levels = c("previous ocs use ~ ics use + race + 21 ratios",
                                                "prospective ocs use ~ ics use + race + 21 ratios",
                                                "prospective ocs use ~ ics use + race",
                                                "incident ocs use ~ race + all clinical biomarker + 21 ratios"))


# Combine the data frames
roc_df <- rbind(roc2_df, roc4_df, roc7_df, roc8_df, roc9_df, roc12_df, roc13_df, 
                roc15_df, roc16_df, roc17_df)

roc_df$model <- factor(roc_df$model, levels = c("previous ocs use ~ ics use + race + 21 ratios",
                                                "prospective ocs use ~ ics use + race + 21 ratios",
                                                "prospective ocs use ~ ics use + race",
                                                "prospective ocs use ~ ocs use + race",
                                                "prospective ocs use ~ eos + race",
                                                "prospective ocs use ~ log(ige) + race",
                                                "prospective ocs use ~ LecCer(d18:1/12:0)/11-deoxycortisol + race + 16 ratios",
                                                "prospective ocs use ~ FEV1 + race",
                                                "prospective ocs use ~ FVC + race",
                                                "prospective ocs use ~ FEV1/FVC + race"))


# Plot using ggplot2 with smoothing
png(file=str_c(fig_dir, "PEGASUS_roc_plot_updated.png"), width = 12, height = 12, units = "in", res = 300)
ggplot(roc_df, aes(x = specificity, y = sensitivity, color = model)) +
  geom_point(alpha = 0.2) +  # Optional: add points; make them slightly transparent
  geom_line() +
  labs(x = "1 - Specificity", y = "Sensitivity") +
  # ggtitle("PEGASUS\nSmoothed ROC curves for multiple models") +
  theme_minimal() + coord_fixed(ratio = 1) +
  theme(legend.position = "bottom",legend.box = "horizontal") +
  guides(color = guide_legend(nrow = 4, byrow = TRUE)) + 
  scale_color_manual(values = c("previous ocs use ~ ics use + race + 21 ratios" = "#F8766D", 
                                "prospective ocs use ~ ics use + race + 21 ratios" = "#A3A500",
                                "prospective ocs use ~ ics use + race" = "#00BF7D",
                                "prospective ocs use ~ ocs use + race" = "#00B0F6",
                                "prospective ocs use ~ eos + race" = "#E76BF3",
                                "prospective ocs use ~ log(ige) + race" = "#FF61C3",
                                "prospective ocs use ~ LecCer(d18:1/12:0)/11-deoxycortisol + race + 16 ratios" = "#7CAE00",
                                "prospective ocs use ~ FEV1 + race" = "#00BE67",
                                "prospective ocs use ~ FVC + race" = "#C77CFF",
                                "prospective ocs use ~ FEV1/FVC + race" = "#FF9A8C"))  # Set the colors manually
dev.off()

```


### histgram
```{r}
hist1 <- ggplot(pheno_tmp, aes(x=Cer20_1d18_1.S10_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/20:1) / DHEAS", y = "Count")

hist2 <- ggplot(pheno_tmp, aes(x=Cer20_0d18_1.S10_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/20:0) / DHEAS", y = "Count")

hist3 <- ggplot(pheno_tmp, aes(x=Cer26_1d18_1.S10_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/26:1) / DHEAS", y = "Count")

hist4 <- ggplot(pheno_tmp, aes(x=SM20_d18_1.S10_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "SM(d18:1/20:0) / DHEAS", y = "Count")

hist5 <- ggplot(pheno_tmp, aes(x=Spad18_0.S10_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Sphinganine(d18:0) / DHEAS", y = "Count")

hist6 <- ggplot(pheno_tmp, aes(x=Sph18_1.S10_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Sphingosine(d18:1) / DHEAS", y = "Count")

hist7 <- ggplot(pheno_tmp, aes(x=Cer20_1d18_1.S8_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/20:1) / cortisone", y = "Count")

hist8 <- ggplot(pheno_tmp, aes(x=Cer26_1d18_1.S8_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/26:1) / cortisone", y = "Count")

hist9 <- ggplot(pheno_tmp, aes(x=HexCer24_1.S8_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "HexCer(d18:1/24:1) / cortisone", y = "Count")

hist10 <- ggplot(pheno_tmp, aes(x=SM20_d18_1.S8_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "SM(d18:1/20:0) / cortisone", y = "Count")

hist11 <- ggplot(pheno_tmp, aes(x=Spad18_0.S8_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Sphinganine(d18:0) / cortisone", y = "Count")

hist12 <- ggplot(pheno_tmp, aes(x=Cer20_1d18_1.S6_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/20:1) / corticosterone", y = "Count")

hist13 <- ggplot(pheno_tmp, aes(x=Cer26_1d18_1.S6_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/26:1) / corticosterone", y = "Count")

hist14 <- ggplot(pheno_tmp, aes(x=HexCer24_1.S6_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "HexCer(d18:1/24:1) / corticosterone", y = "Count")

hist15 <- ggplot(pheno_tmp, aes(x=SM20_d18_1.S6_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "SM(d18:1/20:0) / corticosterone", y = "Count")

hist16 <- ggplot(pheno_tmp, aes(x=Spad18_0.S6_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Sphinganine(d18:0) / corticosterone", y = "Count")

hist17 <- ggplot(pheno_tmp, aes(x=LacCer12_0.S1_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "LacCer(d18:1/12:0) / 11-deoxycortisol", y = "Count")

hist18 <- ggplot(pheno_tmp, aes(x=Cer24_1d16_1.S1_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d16:1/24:1) / 11-deoxycortisol", y = "Count")

hist19 <- ggplot(pheno_tmp, aes(x=Cer24_1d18_2.S1_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:2/24:1) / 11-deoxycortisol", y = "Count")

hist20 <- ggplot(pheno_tmp, aes(x=Cer17_0d18_1.S1_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "Cer(d18:1/17:0) / 11-deoxycortisol", y = "Count")

hist21 <- ggplot(pheno_tmp, aes(x=SM16_0d16_1.S1_steroid)) + geom_histogram(color="darkblue", fill="lightblue") + labs(x = "SM(d16:1/16:0) / 11-deoxycortisol", y = "Count")

png(file=str_c(fig_dir, "PEGASUS_predictors_hist.png"), width = 18, height = 6, units = "in", res = 300)
grid.arrange(hist1, hist2, hist3, hist4, hist5, hist6, hist7, 
             hist8, hist9, hist10, hist11, hist12, hist13, hist14, 
             hist15, hist16, hist17, hist18, hist19, hist20, hist21,
             nrow=3)
dev.off()

```

### Barplot
```{r}
######### bar plot for quantile group
tmp <- data.frame(y, x_new_1) %>% as.data.table()

#########
#1. Cer20_1d18_1.S10_steroid (Cer(d18:1/20:1) / DHEAS)
vTert = quantile(tmp$Cer20_1d18_1.S10_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer20_1d18_1.S10_steroid_tertile = with(tmp, 
                                            cut(Cer20_1d18_1.S10_steroid, 
                                            vTert, 
                                            include.lowest = T, 
                                            labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer20_1d18_1.S10_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb1 <- ggplot(tmp, aes(x = Cer20_1d18_1.S10_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/20:1) / DHEAS",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#2. Cer20_0d18_1.S10_steroid (Cer(d18:1/20:0) / DHEAS)
vTert = quantile(tmp$Cer20_0d18_1.S10_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer20_0d18_1.S10_steroid_tertile = with(tmp, 
                                            cut(Cer20_0d18_1.S10_steroid, 
                                            vTert, 
                                            include.lowest = T, 
                                            labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer20_0d18_1.S10_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb2 <- ggplot(tmp, aes(x = Cer20_0d18_1.S10_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/20:0) / DHEAS",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#3. Cer26_1d18_1.S10_steroid (Cer(d18:1/26:1) / DHEAS)
vTert = quantile(tmp$Cer26_1d18_1.S10_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer26_1d18_1.S10_steroid_tertile = with(tmp, 
                                            cut(Cer26_1d18_1.S10_steroid, 
                                            vTert, 
                                            include.lowest = T, 
                                            labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer26_1d18_1.S10_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb3 <- ggplot(tmp, aes(x = Cer26_1d18_1.S10_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/26:1) / DHEAS",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#4. SM20_d18_1.S10_steroid (SM(d18:1/20:0) / DHEAS)
vTert = quantile(tmp$SM20_d18_1.S10_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$SM20_d18_1.S10_steroid_tertile = with(tmp, 
                                          cut(SM20_d18_1.S10_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(SM20_d18_1.S10_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb4 <- ggplot(tmp, aes(x = SM20_d18_1.S10_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "SM(d18:1/20:0) / DHEAS",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")


#########
#5. Spad18_0.S10_steroid (Sphinganine(d18:0) / DHEAS)
vTert = quantile(tmp$Spad18_0.S10_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Spad18_0.S10_steroid_tertile = with(tmp, 
                                          cut(Spad18_0.S10_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Spad18_0.S10_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb5 <- ggplot(tmp, aes(x = Spad18_0.S10_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Sphinganine(d18:0) / DHEAS",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")


#########
#6. Sph18_1.S10_steroid (Sphingosine(d18:1) / DHEAS)
vTert = quantile(tmp$Sph18_1.S10_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Sph18_1.S10_steroid_tertile = with(tmp, 
                                          cut(Sph18_1.S10_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Sph18_1.S10_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb6 <- ggplot(tmp, aes(x = Sph18_1.S10_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Sphingosine(d18:1) / DHEAS",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#7. Cer20_1d18_1.S8_steroid (Cer(d18:1/20:1) / cortisone)
vTert = quantile(tmp$Cer20_1d18_1.S8_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer20_1d18_1.S8_steroid_tertile = with(tmp, 
                                          cut(Cer20_1d18_1.S8_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer20_1d18_1.S8_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb7 <- ggplot(tmp, aes(x = Cer20_1d18_1.S8_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/20:1) / cortisone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#7. Cer20_1d18_1.S8_steroid (Cer(d18:1/20:1) / cortisone)
vTert = quantile(tmp$Cer20_1d18_1.S8_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer20_1d18_1.S8_steroid_tertile = with(tmp, 
                                          cut(Cer20_1d18_1.S8_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer20_1d18_1.S8_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb7 <- ggplot(tmp, aes(x = Cer20_1d18_1.S8_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/20:1) / cortisone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#8. Cer26_1d18_1.S8_steroid (Cer(d18:1/26:1) / cortisone)
vTert = quantile(tmp$Cer26_1d18_1.S8_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer26_1d18_1.S8_steroid_tertile = with(tmp, 
                                          cut(Cer26_1d18_1.S8_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer26_1d18_1.S8_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb8 <- ggplot(tmp, aes(x = Cer26_1d18_1.S8_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/26:1) / cortisone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#9. HexCer24_1.S8_steroid (HexCer(d18:1/24:1) / cortisone)
vTert = quantile(tmp$HexCer24_1.S8_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$HexCer24_1.S8_steroid_tertile = with(tmp, 
                                          cut(HexCer24_1.S8_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(HexCer24_1.S8_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb9 <- ggplot(tmp, aes(x = HexCer24_1.S8_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "HexCer(d18:1/24:1) / cortisone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#10. SM20_d18_1.S8_steroid (SM(d18:1/20:0) / cortisone)
vTert = quantile(tmp$SM20_d18_1.S8_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$SM20_d18_1.S8_steroid_tertile = with(tmp, 
                                          cut(SM20_d18_1.S8_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(SM20_d18_1.S8_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb10 <- ggplot(tmp, aes(x = SM20_d18_1.S8_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "SM(d18:1/20:0) / cortisone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#11. Spad18_0.S8_steroid (Sphinganine(d18:0) / cortisone)
vTert = quantile(tmp$Spad18_0.S8_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Spad18_0.S8_steroid_tertile = with(tmp, 
                                          cut(Spad18_0.S8_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Spad18_0.S8_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb11 <- ggplot(tmp, aes(x = Spad18_0.S8_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Sphinganine(d18:0) / cortisone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#12. Cer20_1d18_1.S6_steroid (Cer(d18:1/20:1) / corticosterone)
vTert = quantile(tmp$Cer20_1d18_1.S6_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer20_1d18_1.S6_steroid_tertile = with(tmp, 
                                          cut(Cer20_1d18_1.S6_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer20_1d18_1.S6_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb12 <- ggplot(tmp, aes(x = Cer20_1d18_1.S6_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/20:1) / corticosterone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#13. Cer26_1d18_1.S6_steroid (Cer(d18:1/26:1) / corticosterone)
vTert = quantile(tmp$Cer26_1d18_1.S6_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer26_1d18_1.S6_steroid_tertile = with(tmp, 
                                          cut(Cer26_1d18_1.S6_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer26_1d18_1.S6_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb13 <- ggplot(tmp, aes(x = Cer26_1d18_1.S6_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/26:1) / corticosterone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#14. HexCer24_1.S6_steroid (HexCer(d18:1/24:1) / corticosterone)
vTert = quantile(tmp$HexCer24_1.S6_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$HexCer24_1.S6_steroid_tertile = with(tmp, 
                                          cut(HexCer24_1.S6_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(HexCer24_1.S6_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb14 <- ggplot(tmp, aes(x = HexCer24_1.S6_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "HexCer(d18:1/24:1) / corticosterone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#15. SM20_d18_1.S6_steroid (SM(d18:1/20:0) / corticosterone)
vTert = quantile(tmp$SM20_d18_1.S6_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$SM20_d18_1.S6_steroid_tertile = with(tmp, 
                                          cut(SM20_d18_1.S6_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(SM20_d18_1.S6_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb15 <- ggplot(tmp, aes(x = SM20_d18_1.S6_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "SM(d18:1/20:0) / corticosterone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")


#########
#16. Spad18_0.S6_steroid (Sphinganine(d18:0) / corticosterone)
vTert = quantile(tmp$Spad18_0.S6_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Spad18_0.S6_steroid_tertile = with(tmp, 
                                          cut(Spad18_0.S6_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Spad18_0.S6_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb16 <- ggplot(tmp, aes(x = Spad18_0.S6_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Sphinganine(d18:0) / corticosterone",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#17. LacCer12_0.S1_steroid (LacCer(d18:1/12:0) / 11-deoxycortisol)
vTert = quantile(tmp$LacCer12_0.S1_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$LacCer12_0.S1_steroid_tertile = with(tmp, 
                                          cut(LacCer12_0.S1_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(LacCer12_0.S1_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb17 <- ggplot(tmp, aes(x = LacCer12_0.S1_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "LacCer(d18:1/12:0) / 11-deoxycortisol",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#18. Cer24_1d16_1.S1_steroid (Cer(d16:1/24:1) / 11-deoxycortisol)
vTert = quantile(tmp$Cer24_1d16_1.S1_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer24_1d16_1.S1_steroid_tertile = with(tmp, 
                                          cut(Cer24_1d16_1.S1_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer24_1d16_1.S1_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb18 <- ggplot(tmp, aes(x = Cer24_1d16_1.S1_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d16:1/24:1) / 11-deoxycortisol",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#19. Cer24_1d18_2.S1_steroid (Cer(d18:2/24:1) / 11-deoxycortisol)
vTert = quantile(tmp$Cer24_1d18_2.S1_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer24_1d18_2.S1_steroid_tertile = with(tmp, 
                                          cut(Cer24_1d18_2.S1_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer24_1d18_2.S1_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb19 <- ggplot(tmp, aes(x = Cer24_1d18_2.S1_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:2/24:1) / 11-deoxycortisol",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#20. Cer17_0d18_1.S1_steroid (Cer(d18:1/17:0) / 11-deoxycortisol)
vTert = quantile(tmp$Cer17_0d18_1.S1_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$Cer17_0d18_1.S1_steroid_tertile = with(tmp, 
                                          cut(Cer17_0d18_1.S1_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(Cer17_0d18_1.S1_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb20 <- ggplot(tmp, aes(x = Cer17_0d18_1.S1_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "Cer(d18:1/17:0) / 11-deoxycortisol",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
#21. SM16_0d16_1.S1_steroid (Cer(d16:1/16:0) / 11-deoxycortisol)
vTert = quantile(tmp$SM16_0d16_1.S1_steroid, na.rm = T, probs = c(0, 1/3, 2/3, 1))
vTert

tmp$SM16_0d16_1.S1_steroid_tertile = with(tmp, 
                                          cut(SM16_0d16_1.S1_steroid, 
                                          vTert, 
                                          include.lowest = T, 
                                          labels = c("Q1", "Q2", "Q3")))

tmp[, .N, .(SM16_0d16_1.S1_steroid_tertile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pb21 <- ggplot(tmp, aes(x = SM16_0d16_1.S1_steroid_tertile, fill = as.factor(y))) +
  geom_bar(position = "dodge") +  # "dodge" will place bars side-by-side
  labs(
    x = "SM(d16:1/16:0) / 11-deoxycortisol",
    y = "Count"
  ) +
  theme_minimal() + theme(legend.position = "none")

#########
png(filename = str_c(fig_dir, "PEGASUS_predictors_barplot.png"), width = 18, height = 6, units = "in", res = 300)
grid.arrange(pb1, pb2, pb3, pb4, pb5, pb6, pb7,
             pb8, pb9, pb10, pb11, pb12, pb13, pb14,
             pb15, pb16, pb17, pb18, pb19, pb20, pb21,
             nrow=3)
dev.off()
```

### Cox -- 1. Cer20_1d18_1.S10_steroid
```{r}
# Cer20_1d18_1.S10_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer20_1d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer20_1d18_1 + S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer20_1d18_1.S10_steroid, na.rm = T)
vTert
pheno_tmp$Cer20_1d18_1.S10_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer20_1d18_1.S10_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer20_1d18_1.S10_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer20_1d18_1.S10_steroid_cat2 <- with(pheno_tmp, ifelse(Cer20_1d18_1.S10_steroid_quantile == "Q1", "Q1", ifelse(Cer20_1d18_1.S10_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer20_1d18_1.S10_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S10_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/20:1) / DHEAS",
          fun = "event")

gs1 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/20:1) / DHEAS",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S10_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer20_1d18_1.S10_steroid_cat2), c("Cer20_1d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_1d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer20_1d18_1.S10_steroid_cat2), c("Cer20_1d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_1d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 2. Cer20_0d18_1.S10_steroid
```{r}
# Cer20_0d18_1.S10_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer20_0d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer20_0d18_1 + S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer20_0d18_1.S10_steroid, na.rm = T)
vTert
pheno_tmp$Cer20_0d18_1.S10_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer20_0d18_1.S10_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer20_0d18_1.S10_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer20_0d18_1.S10_steroid_cat2 <- with(pheno_tmp, ifelse(Cer20_0d18_1.S10_steroid_quantile == "Q1", "Q1", ifelse(Cer20_0d18_1.S10_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer20_0d18_1.S10_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_0d18_1.S10_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/20:0) / DHEAS",
          fun = "event")

gs2 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/20:0) / DHEAS",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_0d18_1.S10_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_0d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer20_0d18_1.S10_steroid_cat2), c("Cer20_0d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_0d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer20_0d18_1.S10_steroid_cat2), c("Cer20_0d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_0d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 3. Cer26_1d18_1.S10_steroid
```{r}
# Cer26_1d18_1.S10_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer26_1d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer26_1d18_1 + S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer26_1d18_1.S10_steroid, na.rm = T)
vTert
pheno_tmp$Cer26_1d18_1.S10_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer26_1d18_1.S10_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer26_1d18_1.S10_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer26_1d18_1.S10_steroid_cat2 <- with(pheno_tmp, ifelse(Cer26_1d18_1.S10_steroid_quantile == "Q1", "Q1", ifelse(Cer26_1d18_1.S10_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer26_1d18_1.S10_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S10_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/26:1) / DHEAS",
          fun = "event")

gs3 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/26:1) / DHEAS",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S10_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer26_1d18_1.S10_steroid_cat2), c("Cer26_1d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer26_1d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer26_1d18_1.S10_steroid_cat2), c("Cer26_1d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer26_1d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 4. SM20_d18_1.S10_steroid
```{r}
# SM20_d18_1.S10_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ SM20_d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ SM20_d18_1 + S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$SM20_d18_1.S10_steroid, na.rm = T)
vTert
pheno_tmp$SM20_d18_1.S10_steroid_quantile = with(pheno_tmp, 
                                                 cut(SM20_d18_1.S10_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(SM20_d18_1.S10_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$SM20_d18_1.S10_steroid_cat2 <- with(pheno_tmp, ifelse(SM20_d18_1.S10_steroid_quantile == "Q1", "Q1", ifelse(SM20_d18_1.S10_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$SM20_d18_1.S10_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S10_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "SM(d18:1/20:0) / DHEAS",
          fun = "event")

gs4 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "SM(d18:1/20:0) / DHEAS",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S10_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(SM20_d18_1.S10_steroid_cat2), c("SM20_d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM20_d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(SM20_d18_1.S10_steroid_cat2), c("SM20_d18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM20_d18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 5. Spad18_0.S10_steroid
```{r}
# Spad18_0.S10_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Spad18_0.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Spad18_0 + S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Spad18_0.S10_steroid, na.rm = T)
vTert
pheno_tmp$Spad18_0.S10_steroid_quantile = with(pheno_tmp, 
                                                 cut(Spad18_0.S10_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Spad18_0.S10_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Spad18_0.S10_steroid_cat2 <- with(pheno_tmp, ifelse(Spad18_0.S10_steroid_quantile == "Q1", "Q1", ifelse(Spad18_0.S10_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Spad18_0.S10_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S10_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Sphinganine(d18:0) / DHEAS",
          fun = "event")

gs5 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Sphinganine(d18:0) / DHEAS",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S10_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Spad18_0.S10_steroid_cat2), c("Spad18_0.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Spad18_0.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Spad18_0.S10_steroid_cat2), c("Spad18_0.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Spad18_0.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```

### Cox -- 6. Sph18_1.S10_steroid
```{r}
# Sph18_1.S10_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Sph18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Sph18_1 + S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Sph18_1.S10_steroid, na.rm = T)
vTert
pheno_tmp$Sph18_1.S10_steroid_quantile = with(pheno_tmp, 
                                                 cut(Sph18_1.S10_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Sph18_1.S10_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Sph18_1.S10_steroid_cat2 <- with(pheno_tmp, ifelse(Sph18_1.S10_steroid_quantile == "Q1", "Q1", ifelse(Sph18_1.S10_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Sph18_1.S10_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Sph18_1.S10_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Sphingosine(d18:1) / DHEAS",
          fun = "event")

gs6 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Sphingosine(d18:1) / DHEAS",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Sph18_1.S10_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Sph18_1.S10_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Sph18_1.S10_steroid_cat2), c("Sph18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Sph18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Sph18_1.S10_steroid_cat2), c("Sph18_1.S10_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Sph18_1.S10_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 7. Cer20_1d18_1.S8_steroid
```{r}
# Cer20_1d18_1.S8_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer20_1d18_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer20_1d18_1 + S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer20_1d18_1.S8_steroid, na.rm = T)
vTert
pheno_tmp$Cer20_1d18_1.S8_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer20_1d18_1.S8_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer20_1d18_1.S8_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer20_1d18_1.S8_steroid_cat2 <- with(pheno_tmp, ifelse(Cer20_1d18_1.S8_steroid_quantile == "Q1", "Q1", ifelse(Cer20_1d18_1.S8_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer20_1d18_1.S8_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S8_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/20:1) / cortisone",
          fun = "event")

gs7 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/20:1) / cortisone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S8_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer20_1d18_1.S8_steroid_cat2), c("Cer20_1d18_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_1d18_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer20_1d18_1.S8_steroid_cat2), c("Cer20_1d18_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_1d18_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 8. Cer26_1d18_1.S8_steroid
```{r}
# Cer26_1d18_1.S8_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer26_1d18_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer26_1d18_1 + S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer26_1d18_1.S8_steroid, na.rm = T)
vTert
pheno_tmp$Cer26_1d18_1.S8_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer26_1d18_1.S8_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer26_1d18_1.S8_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer26_1d18_1.S8_steroid_cat2 <- with(pheno_tmp, ifelse(Cer26_1d18_1.S8_steroid_quantile == "Q1", "Q1", ifelse(Cer26_1d18_1.S8_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer26_1d18_1.S8_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S8_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/26:1) / cortisone",
          fun = "event")

gs8 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/26:1) / cortisone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S8_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer26_1d18_1.S8_steroid_cat2), c("Cer26_1d18_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer26_1d18_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer26_1d18_1.S8_steroid_cat2), c("Cer26_1d18_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer26_1d18_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 9. HexCer24_1.S8_steroid
```{r}
# HexCer24_1.S8_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ HexCer24_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ HexCer24_1 + S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$HexCer24_1.S8_steroid, na.rm = T)
vTert
pheno_tmp$HexCer24_1.S8_steroid_quantile = with(pheno_tmp, 
                                                 cut(HexCer24_1.S8_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(HexCer24_1.S8_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$HexCer24_1.S8_steroid_cat2 <- with(pheno_tmp, ifelse(HexCer24_1.S8_steroid_quantile == "Q1", "Q1", ifelse(HexCer24_1.S8_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$HexCer24_1.S8_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ HexCer24_1.S8_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "HexCer(d18:1/24:1) / cortisone",
          fun = "event")

gs9 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "HexCer(d18:1/24:1) / cortisone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ HexCer24_1.S8_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ HexCer24_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(HexCer24_1.S8_steroid_cat2), c("HexCer24_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(HexCer24_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(HexCer24_1.S8_steroid_cat2), c("HexCer24_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(HexCer24_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 10. SM20_d18_1.S8_steroid
```{r}
# SM20_d18_1.S8_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ SM20_d18_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ SM20_d18_1 + S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$SM20_d18_1.S8_steroid, na.rm = T)
vTert
pheno_tmp$SM20_d18_1.S8_steroid_quantile = with(pheno_tmp, 
                                                 cut(SM20_d18_1.S8_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(SM20_d18_1.S8_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$SM20_d18_1.S8_steroid_cat2 <- with(pheno_tmp, ifelse(SM20_d18_1.S8_steroid_quantile == "Q1", "Q1", ifelse(SM20_d18_1.S8_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$SM20_d18_1.S8_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S8_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "SM(d18:1/20:0) / cortisone",
          fun = "event")

gs10 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "SM(d18:1/20:0) / cortisone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S8_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(SM20_d18_1.S8_steroid_cat2), c("SM20_d18_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM20_d18_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(SM20_d18_1.S8_steroid_cat2), c("SM20_d18_1.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM20_d18_1.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 11. Spad18_0.S8_steroid
```{r}
# Spad18_0.S8_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Spad18_0.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Spad18_0 + S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Spad18_0.S8_steroid, na.rm = T)
vTert
pheno_tmp$Spad18_0.S8_steroid_quantile = with(pheno_tmp, 
                                                 cut(Spad18_0.S8_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Spad18_0.S8_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Spad18_0.S8_steroid_cat2 <- with(pheno_tmp, ifelse(Spad18_0.S8_steroid_quantile == "Q1", "Q1", ifelse(Spad18_0.S8_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Spad18_0.S8_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S8_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Sphinganine(d18:0) / cortisone",
          fun = "event")

gs11 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Sphinganine(d18:0) / cortisone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S8_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S8_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Spad18_0.S8_steroid_cat2), c("Spad18_0.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Spad18_0.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Spad18_0.S8_steroid_cat2), c("Spad18_0.S8_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Spad18_0.S8_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 12. Cer20_1d18_1.S6_steroid
```{r}
# Cer20_1d18_1.S6_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer20_1d18_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer20_1d18_1 + S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer20_1d18_1.S6_steroid, na.rm = T)
vTert
pheno_tmp$Cer20_1d18_1.S6_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer20_1d18_1.S6_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer20_1d18_1.S6_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer20_1d18_1.S6_steroid_cat2 <- with(pheno_tmp, ifelse(Cer20_1d18_1.S6_steroid_quantile == "Q1", "Q1", ifelse(Cer20_1d18_1.S6_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer20_1d18_1.S6_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S6_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/20:1) / corticosterone",
          fun = "event")

gs12 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/20:1) / corticosterone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S6_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer20_1d18_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer20_1d18_1.S6_steroid_cat2), c("Cer20_1d18_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_1d18_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer20_1d18_1.S6_steroid_cat2), c("Cer20_1d18_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer20_1d18_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 13. Cer26_1d18_1.S6_steroid
```{r}
# Cer26_1d18_1.S6_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer26_1d18_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer26_1d18_1 + S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer26_1d18_1.S6_steroid, na.rm = T)
vTert
pheno_tmp$Cer26_1d18_1.S6_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer26_1d18_1.S6_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer26_1d18_1.S6_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer26_1d18_1.S6_steroid_cat2 <- with(pheno_tmp, ifelse(Cer26_1d18_1.S6_steroid_quantile == "Q1", "Q1", ifelse(Cer26_1d18_1.S6_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer26_1d18_1.S6_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S6_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/26:1) / corticosterone",
          fun = "event")

gs13 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/26:1) / corticosterone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S6_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer26_1d18_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer26_1d18_1.S6_steroid_cat2), c("Cer26_1d18_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer26_1d18_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer26_1d18_1.S6_steroid_cat2), c("Cer26_1d18_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer26_1d18_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 14. HexCer24_1.S6_steroid
```{r}
# HexCer24_1.S6_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ HexCer24_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ HexCer24_1 + S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$HexCer24_1.S6_steroid, na.rm = T)
vTert
pheno_tmp$HexCer24_1.S6_steroid_quantile = with(pheno_tmp, 
                                                 cut(HexCer24_1.S6_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(HexCer24_1.S6_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$HexCer24_1.S6_steroid_cat2 <- with(pheno_tmp, ifelse(HexCer24_1.S6_steroid_quantile == "Q1", "Q1", ifelse(HexCer24_1.S6_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$HexCer24_1.S6_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ HexCer24_1.S6_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "HexCer(d18:1/24:1) / corticosterone",
          fun = "event")

gs14 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "HexCer(d18:1/24:1) / corticosterone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ HexCer24_1.S6_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ HexCer24_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(HexCer24_1.S6_steroid_cat2), c("HexCer24_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(HexCer24_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(HexCer24_1.S6_steroid_cat2), c("HexCer24_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(HexCer24_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 15. SM20_d18_1.S6_steroid
```{r}
# SM20_d18_1.S6_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ SM20_d18_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ SM20_d18_1 + S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$SM20_d18_1.S6_steroid, na.rm = T)
vTert
pheno_tmp$SM20_d18_1.S6_steroid_quantile = with(pheno_tmp, 
                                                 cut(SM20_d18_1.S6_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(SM20_d18_1.S6_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$SM20_d18_1.S6_steroid_cat2 <- with(pheno_tmp, ifelse(SM20_d18_1.S6_steroid_quantile == "Q1", "Q1", ifelse(SM20_d18_1.S6_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$SM20_d18_1.S6_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S6_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "SM(d18:1/20:0) / corticosterone",
          fun = "event")

gs15 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "SM(d18:1/20:0) / corticosterone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S6_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM20_d18_1.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(SM20_d18_1.S6_steroid_cat2), c("SM20_d18_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM20_d18_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(SM20_d18_1.S6_steroid_cat2), c("SM20_d18_1.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM20_d18_1.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 16. Spad18_0.S6_steroid
```{r}
# Spad18_0.S6_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Spad18_0.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Spad18_0 + S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Spad18_0.S6_steroid, na.rm = T)
vTert
pheno_tmp$Spad18_0.S6_steroid_quantile = with(pheno_tmp, 
                                                 cut(Spad18_0.S6_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Spad18_0.S6_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Spad18_0.S6_steroid_cat2 <- with(pheno_tmp, ifelse(Spad18_0.S6_steroid_quantile == "Q1", "Q1", ifelse(Spad18_0.S6_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Spad18_0.S6_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S6_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Sphinganine(d18:0) / corticosterone",
          fun = "event")

gs16 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Sphinganine(d18:0) / corticosterone",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S6_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Spad18_0.S6_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Spad18_0.S6_steroid_cat2), c("Spad18_0.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Spad18_0.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Spad18_0.S6_steroid_cat2), c("Spad18_0.S6_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Spad18_0.S6_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```


### Cox -- 17. LacCer12_0.S1_steroid
```{r}
# LacCer12_0.S1_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ LacCer12_0.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ LacCer12_0 + S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$LacCer12_0.S1_steroid, na.rm = T)
vTert
pheno_tmp$LacCer12_0.S1_steroid_quantile = with(pheno_tmp, 
                                                 cut(LacCer12_0.S1_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(LacCer12_0.S1_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$LacCer12_0.S1_steroid_cat2 <- with(pheno_tmp, ifelse(LacCer12_0.S1_steroid_quantile == "Q1", "Q1", ifelse(LacCer12_0.S1_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$LacCer12_0.S1_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ LacCer12_0.S1_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "LacCer(d18:1/12:0) / 11-deoxycortisol",
          fun = "event")

gs17 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "LacCer(d18:1/12:0) / 11-deoxycortisol",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ LacCer12_0.S1_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ LacCer12_0.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(LacCer12_0.S1_steroid_cat2), c("LacCer12_0.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(LacCer12_0.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(LacCer12_0.S1_steroid_cat2), c("LacCer12_0.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(LacCer12_0.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```




### Cox -- 18. Cer24_1d16_1.S1_steroid
```{r}
# Cer24_1d16_1.S1_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer24_1d16_1.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer24_1d16_1 + S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer24_1d16_1.S1_steroid, na.rm = T)
vTert
pheno_tmp$Cer24_1d16_1.S1_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer24_1d16_1.S1_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer24_1d16_1.S1_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer24_1d16_1.S1_steroid_cat2 <- with(pheno_tmp, ifelse(Cer24_1d16_1.S1_steroid_quantile == "Q1", "Q1", ifelse(Cer24_1d16_1.S1_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer24_1d16_1.S1_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer24_1d16_1.S1_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d16:1/24:1) / 11-deoxycortisol",
          fun = "event")

gs18 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d16:1/24:1) / 11-deoxycortisol",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer24_1d16_1.S1_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer24_1d16_1.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer24_1d16_1.S1_steroid_cat2), c("Cer24_1d16_1.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer24_1d16_1.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer24_1d16_1.S1_steroid_cat2), c("Cer24_1d16_1.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer24_1d16_1.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```




### Cox -- 19. Cer24_1d18_2.S1_steroid
```{r}
# Cer24_1d18_2.S1_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer24_1d18_2.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer24_1d18_2 + S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer24_1d18_2.S1_steroid, na.rm = T)
vTert
pheno_tmp$Cer24_1d18_2.S1_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer24_1d18_2.S1_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer24_1d18_2.S1_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer24_1d18_2.S1_steroid_cat2 <- with(pheno_tmp, ifelse(Cer24_1d18_2.S1_steroid_quantile == "Q1", "Q1", ifelse(Cer24_1d18_2.S1_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer24_1d18_2.S1_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer24_1d18_2.S1_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:2/24:1) / 11-deoxycortisol",
          fun = "event")

gs19 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:2/24:1) / 11-deoxycortisol",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer24_1d18_2.S1_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer24_1d18_2.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer24_1d18_2.S1_steroid_cat2), c("Cer24_1d18_2.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer24_1d18_2.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer24_1d18_2.S1_steroid_cat2), c("Cer24_1d18_2.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer24_1d18_2.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```




### Cox -- 20. Cer17_0d18_1.S1_steroid
```{r}
# Cer17_0d18_1.S1_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ Cer17_0d18_1.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ Cer17_0d18_1 + S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$Cer17_0d18_1.S1_steroid, na.rm = T)
vTert
pheno_tmp$Cer17_0d18_1.S1_steroid_quantile = with(pheno_tmp, 
                                                 cut(Cer17_0d18_1.S1_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(Cer17_0d18_1.S1_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$Cer17_0d18_1.S1_steroid_cat2 <- with(pheno_tmp, ifelse(Cer17_0d18_1.S1_steroid_quantile == "Q1", "Q1", ifelse(Cer17_0d18_1.S1_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$Cer17_0d18_1.S1_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer17_0d18_1.S1_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "Cer(d18:1/17:0) / 11-deoxycortisol",
          fun = "event")

gs20 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "Cer(d18:1/17:0) / 11-deoxycortisol",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer17_0d18_1.S1_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ Cer17_0d18_1.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(Cer17_0d18_1.S1_steroid_cat2), c("Cer17_0d18_1.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer17_0d18_1.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(Cer17_0d18_1.S1_steroid_cat2), c("Cer17_0d18_1.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(Cer17_0d18_1.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```




### Cox -- 21. SM16_0d16_1.S1_steroid
```{r}
# SM16_0d16_1.S1_steroid		
## compare model 1) y ~ log(a/b) + covariate and 2) y ~ log(a) + log(b) + covariate
model_1 <- lm(ocs_trim_totnum_5y_after ~ SM16_0d16_1.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_1)

model_2 <- lm(ocs_trim_totnum_5y_after ~ SM16_0d16_1 + S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(model_2)

# anova(model_1, model_2)

## boxplot for ratio
## distribution
vTert = quantile(pheno_tmp$SM16_0d16_1.S1_steroid, na.rm = T)
vTert
pheno_tmp$SM16_0d16_1.S1_steroid_quantile = with(pheno_tmp, 
                                                 cut(SM16_0d16_1.S1_steroid, 
                                                 vTert, 
                                                 include.lowest = T, 
                                                 labels = c("Q1", "Q2", "Q3", "Q4")))

pheno_tmp[, .N, .(SM16_0d16_1.S1_steroid_quantile)][order(-N)][, pct := N/sum(N)*100] %>% print(digits = 3)

pheno_tmp$SM16_0d16_1.S1_steroid_cat2 <- with(pheno_tmp, ifelse(SM16_0d16_1.S1_steroid_quantile == "Q1", "Q1", ifelse(SM16_0d16_1.S1_steroid_quantile == "Q4", "Q4", NA)))
table(pheno_tmp$SM16_0d16_1.S1_steroid_cat2)

fit <- survfit(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM16_0d16_1.S1_steroid_cat2, data = pheno_tmp)
print(fit)

ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Q4", "Q1"),
          title = "SM(d16:1/16:0) / 11-deoxycortisol",
          fun = "event")

gs21 <- ggsurvplot(fit,
                  conf.int = TRUE,
                  risk.table.col = "strata", # Change risk table color by groups
                  ggtheme = theme_bw(), # Change ggplot2 theme
                  palette = c("#E7B800", "#2E9FDF"),
                  legend.labs = c("Q4", "Q1"),
                  title = "SM(d16:1/16:0) / 11-deoxycortisol",
                  fun = "event")

### Comparing survival times between groups
survdiff(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM16_0d16_1.S1_steroid_cat2, data = pheno_tmp)

## 
cox1 <- coxph(Surv(cs_timegap_y_ocs_after, ocs_ocs_after) ~ SM16_0d16_1.S1_steroid + Age_at_Collection + bmi + Gender + race + Ethnicity + ics_trim_totnum_5y, data = pheno_tmp)
summary(cox1)

## mean of first OCS medication day across different ratio groups
stats_summary_y <- pheno_tmp[!is.na(SM16_0d16_1.S1_steroid_cat2), c("SM16_0d16_1.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM16_0d16_1.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_y_ocs_after, na.rm = T),
            sd = sd(cs_timegap_y_ocs_after, na.rm = T),
            median = median(cs_timegap_y_ocs_after, na.rm = T))

stats_summary_y

stats_summary_d <- pheno_tmp[!is.na(SM16_0d16_1.S1_steroid_cat2), c("SM16_0d16_1.S1_steroid_cat2", "cs_timegap_y_ocs_after", "cs_timegap_d_ocs_after")] %>%
  group_by(SM16_0d16_1.S1_steroid_cat2) %>%
  summarise(mean = mean(cs_timegap_d_ocs_after, na.rm = T),
            sd = sd(cs_timegap_d_ocs_after, na.rm = T),
            median = median(cs_timegap_d_ocs_after, na.rm = T))

stats_summary_d
```

### Com Plot
```{r}
png(filename = str_c(fig_dir, "PEGASUS_predictors_cum_plot.png"), width = 22, height = 11, units = "in", res = 300)
grid.arrange(gs1$plot, gs2$plot, gs3$plot, gs4$plot, gs5$plot, gs6$plot, gs7$plot,
             gs8$plot, gs9$plot, gs10$plot, gs11$plot, gs12$plot, gs13$plot, gs14$plot,
             gs15$plot, gs16$plot, gs17$plot, gs18$plot, gs19$plot, gs20$plot, gs21$plot,
             nrow=3)
dev.off()
```

# Session info
```{r}
sessionInfo()

```


